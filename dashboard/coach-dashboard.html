// Import database configuration
import { supabase, dbManager } from './js/supabase-config.js';

// Keep sample clients for demonstration + real client integration
let realClients = [];

// Complete sample clients data for demonstration
let sampleClients = [
    {
        id: 'client001',
        name: 'Sarah Johnson',
        email: 'sarah.j@email.com',
        assignedCoachId: 'coach_lesley',
        lastActivity: '2025-01-08T10:30:00Z',
        coachingPackage: {
            type: '6-week',
            sessionsTotal: 6,
            sessionsCompleted: 2,
            startDate: '2024-12-01',
            status: 'active'
        },
        moduleAccess: {
            fiveAnchors: {
                physical: { guide: true, webTool: false, sessionUnlocked: 1 },
                mental: { guide: true, webTool: false, sessionUnlocked: 2 },
                emotional: { guide: false, webTool: false, sessionUnlocked: 3 },
                spiritual: { guide: false, webTool: false, sessionUnlocked: 4 },
                relational: { guide: false, webTool: false, sessionUnlocked: 5 }
            },
            discernmentTools: {
                packageRequired: '12-week',
                thoughtRefiner: { unlocked: false, sessionUnlocked: 7 },
                beliefThreader: { unlocked: false, sessionUnlocked: 8 },
                echoEraser: { unlocked: false, sessionUnlocked: 9 },
                forgivenessFilter: { unlocked: false, sessionUnlocked: 10 },
                connectionCalibrator: { unlocked: false, sessionUnlocked: 11 }
            },
            supplementaryContent: []
        },
        checkIns: {
            '2025-01-08': {
                ratings: { physical: 4, mental: 3, emotional: 2, spiritual: 4, relational: 3 },
                notes: { emotional: 'Feeling overwhelmed with work deadlines' }
            }
        }
    },
    {
        id: 'client002', 
        name: 'Michael Chen',
        email: 'mchen@email.com',
        assignedCoachId: 'coach_lesley',
        lastActivity: '2025-01-07T16:45:00Z',
        coachingPackage: {
            type: '12-week',
            sessionsTotal: 12,
            sessionsCompleted: 8,
            startDate: '2024-10-15',
            status: 'active'
        },
        moduleAccess: {
            fiveAnchors: {
                physical: { guide: true, webTool: true, sessionUnlocked: 1 },
                mental: { guide: true, webTool: true, sessionUnlocked: 2 },
                emotional: { guide: true, webTool: true, sessionUnlocked: 3 },
                spiritual: { guide: true, webTool: false, sessionUnlocked: 4 },
                relational: { guide: true, webTool: false, sessionUnlocked: 5 }
            },
            discernmentTools: {
                packageRequired: '12-week',
                thoughtRefiner: { unlocked: true, sessionUnlocked: 7 },
                beliefThreader: { unlocked: true, sessionUnlocked: 8 },
                echoEraser: { unlocked: false, sessionUnlocked: 9 },
                forgivenessFilter: { unlocked: false, sessionUnlocked: 10 },
                connectionCalibrator: { unlocked: false, sessionUnlocked: 11 }
            },
            supplementaryContent: [
                { id: 'bonus_pdf_001', title: 'Advanced Grounding Techniques', type: 'pdf', unlocked: true },
                { id: 'video_001', title: 'Discernment in Daily Life', type: 'video', unlocked: false }
            ]
        },
        checkIns: {
            '2025-01-07': {
                ratings: { physical: 2, mental: 2, emotional: 1, spiritual: 3, relational: 2 },
                notes: { 
                    emotional: 'Relationship stress affecting everything',
                    physical: 'Not sleeping well, very tired'
                }
            }
        }
    },
    {
        id: 'client003',
        name: 'Emma Rodriguez', 
        email: 'emma.r@email.com',
        assignedCoachId: 'coach_lesley',
        lastActivity: '2025-01-08T08:15:00Z',
        coachingPackage: {
            type: '6-week',
            sessionsTotal: 6,
            sessionsCompleted: 5,
            startDate: '2024-11-15',
            status: 'active'
        },
        moduleAccess: {
            fiveAnchors: {
                physical: { guide: true, webTool: true, sessionUnlocked: 1 },
                mental: { guide: true, webTool: true, sessionUnlocked: 2 },
                emotional: { guide: true, webTool: true, sessionUnlocked: 3 },
                spiritual: { guide: true, webTool: true, sessionUnlocked: 4 },
                relational: { guide: true, webTool: false, sessionUnlocked: 5 }
            },
            discernmentTools: {
                packageRequired: '12-week',
                thoughtRefiner: { unlocked: false, sessionUnlocked: 7 },
                beliefThreader: { unlocked: false, sessionUnlocked: 8 },
                echoEraser: { unlocked: false, sessionUnlocked: 9 },
                forgivenessFilter: { unlocked: false, sessionUnlocked: 10 },
                connectionCalibrator: { unlocked: false, sessionUnlocked: 11 }
            },
            supplementaryContent: [
                { id: 'integration_guide', title: '6-Week Integration Guide', type: 'pdf', unlocked: true }
            ]
        },
        checkIns: {
            '2025-01-08': {
                ratings: { physical: 5, mental: 4, emotional: 4, spiritual: 5, relational: 4 },
                notes: { spiritual: 'Amazing prayer time this morning' }
            }
        }
    }
];

const availableCoaches = [
    { id: 'coach_lesley', name: 'Lesley Turner', role: 'Lead Coach' },
    { id: 'coach_sarah', name: 'Sarah Johnson', role: 'Associate Coach' },
    { id: 'coach_mike', name: 'Mike Chen', role: 'Associate Coach' }
];

// Module definitions
const moduleDefinitions = {
    fiveAnchors: [
        { key: 'physical', title: 'Physical Anchor', description: 'Grounding and body awareness guide + web tool', sessionUnlocked: 1 },
        { key: 'mental', title: 'Mental Anchor', description: 'Mental clarity and filtering guide + web tool', sessionUnlocked: 2 },
        { key: 'emotional', title: 'Emotional Anchor', description: 'Emotional stability and regulation guide + web tool', sessionUnlocked: 3 },
        { key: 'spiritual', title: 'Spiritual Anchor', description: 'Spiritual grounding and communion guide + web tool', sessionUnlocked: 4 },
        { key: 'relational', title: 'Relational Anchor', description: 'Relationship harmony and boundaries guide + web tool', sessionUnlocked: 5 }
    ],
    discernmentTools: [
        { key: 'thoughtRefiner', title: 'Thought Refiner', description: 'Advanced mental filtering and truth detection', sessionUnlocked: 7 },
        { key: 'beliefThreader', title: 'Belief Threader', description: 'Examining and dissolving crystallized thought patterns', sessionUnlocked: 8 },
        { key: 'echoEraser', title: 'Echo Eraser', description: 'Clearing energetic residue and integration', sessionUnlocked: 9 },
        { key: 'forgivenessFilter', title: 'Forgiveness Filter', description: 'Processing hurt and finding authentic forgiveness', sessionUnlocked: 10 },
        { key: 'connectionCalibrator', title: 'Connection Calibrator', description: 'Balancing relationship dynamics and boundaries', sessionUnlocked: 11 }
    ]
};

let currentCoachId = 'coach_lesley';
let supervisorMode = false;
let selectedModuleClient = null;
let transferClientId = null;
let currentDetailClientId = null;

// Load real clients from database (when they exist)
async function loadRealClientsFromDatabase() {
    try {
        console.log('Checking for real clients in database...');
        
        // Get all client profiles with their coaching information
        const { data: profiles, error: profileError } = await supabase
            .from('profiles')
            .select(`
                id, email, full_name, coaching_package, sessions_completed, 
                sessions_total, start_date, status, assigned_coach_id, created_at
            `)
            .eq('role', 'client');

        if (profileError) {
            console.error('Database not available or error loading profiles:', profileError);
            return [];
        }

        if (!profiles || profiles.length === 0) {
            console.log('No real clients found in database yet - using sample data for demonstration');
            return [];
        }

        const clients = [];
        
        for (const profile of profiles) {
            // Get latest check-in for each client
            const { data: checkIns, error: checkInError } = await supabase
                .from('daily_checkins')
                .select('*')
                .eq('client_id', profile.id)
                .order('checkin_date', { ascending: false })
                .limit(7);

            // Get intake responses for baseline data
            const { data: intakeData, error: intakeError } = await supabase
                .from('intake_responses')
                .select('*')
                .eq('client_id', profile.id)
                .single();

            // Get module access
            const { data: moduleAccess, error: moduleError } = await supabase
                .from('module_access')
                .select('*')
                .eq('user_id', profile.id);

            // Transform to match existing coach dashboard format
            const client = {
                id: profile.id,
                name: profile.full_name || 'Unknown Client',
                email: profile.email,
                assignedCoachId: profile.assigned_coach_id || 'coach_lesley',
                lastActivity: checkIns && checkIns.length > 0 ? checkIns[0].created_at : profile.created_at,
                coachingPackage: {
                    type: profile.coaching_package || '6-week',
                    sessionsTotal: profile.sessions_total || 6,
                    sessionsCompleted: profile.sessions_completed || 0,
                    startDate: profile.start_date || profile.created_at.split('T')[0],
                    status: profile.status || 'active'
                },
                moduleAccess: transformModuleAccess(moduleAccess),
                checkIns: transformCheckIns(checkIns),
                intakeBaseline: intakeData?.baseline_anchor_scores || null,
                isRealClient: true // Flag to distinguish from sample data
            };

            clients.push(client);
        }

        console.log(`Found ${clients.length} real clients from live automation system`);
        return clients;
        
    } catch (error) {
        console.error('Database connection failed, using sample data:', error);
        return [];
    }
}

// Transform module access data to match expected format
function transformModuleAccess(moduleAccessData) {
    const access = {
        fiveAnchors: {
            physical: { guide: false, webTool: false, sessionUnlocked: 1 },
            mental: { guide: false, webTool: false, sessionUnlocked: 2 },
            emotional: { guide: false, webTool: false, sessionUnlocked: 3 },
            spiritual: { guide: false, webTool: false, sessionUnlocked: 4 },
            relational: { guide: false, webTool: false, sessionUnlocked: 5 }
        },
        discernmentTools: {
            packageRequired: '12-week',
            thoughtRefiner: { unlocked: false, sessionUnlocked: 7 },
            beliefThreader: { unlocked: false, sessionUnlocked: 8 },
            echoEraser: { unlocked: false, sessionUnlocked: 9 },
            forgivenessFilter: { unlocked: false, sessionUnlocked: 10 },
            connectionCalibrator: { unlocked: false, sessionUnlocked: 11 }
        },
        supplementaryContent: []
    };

    if (moduleAccessData) {
        moduleAccessData.forEach(item => {
            if (item.module_type === 'fiveAnchors' && access.fiveAnchors[item.module_key]) {
                access.fiveAnchors[item.module_key][item.access_type] = item.unlocked;
            } else if (item.module_type === 'discernmentTools' && access.discernmentTools[item.module_key]) {
                access.discernmentTools[item.module_key].unlocked = item.unlocked;
            }
        });
    }

    return access;
}

// Transform check-ins to match expected format
function transformCheckIns(checkInData) {
    const checkIns = {};
    
    if (checkInData && checkInData.length > 0) {
        checkInData.forEach(checkIn => {
            checkIns[checkIn.checkin_date] = {
                ratings: checkIn.ratings || {},
                notes: checkIn.notes || {}
            };
        });
    }
    
    return checkIns;
}

function showSection(sectionName) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    
    const section = document.getElementById(sectionName);
    const navItem = document.querySelector(`[data-section="${sectionName}"]`);
    
    if (section) section.classList.add('active');
    if (navItem) navItem.classList.add('active');

    // Initialize module management when section is shown
    if (sectionName === 'modules') {
        initializeModuleManagement();
    }
}

function filterClientsByCoach() {
    const filterValue = document.getElementById('coach-filter').value;
    const viewIndicator = document.getElementById('view-indicator');
    const supervisorToggle = document.getElementById('supervisor-mode');
    
    if (filterValue === 'all') {
        supervisorMode = true;
        viewIndicator.textContent = 'Supervisor View - All Coaches';
        supervisorToggle.classList.add('active');
        supervisorToggle.textContent = 'Disable Supervisor View';
    } else if (filterValue === 'current') {
        supervisorMode = false;
        viewIndicator.textContent = 'Individual Coach View';
        supervisorToggle.classList.remove('active');
        supervisorToggle.textContent = 'Enable Supervisor View';
    } else {
        supervisorMode = true;
        const selectedCoach = availableCoaches.find(coach => coach.id === filterValue);
        viewIndicator.textContent = `Viewing: ${selectedCoach?.name || 'Unknown Coach'}`;
        supervisorToggle.classList.add('active');
        supervisorToggle.textContent = 'Disable Supervisor View';
    }
    
    loadClients();
}

// Update getFilteredClients to use hybrid approach
function getFilteredClients(clientsArray = null) {
    const activeClients = clientsArray || (realClients.length > 0 ? realClients : sampleClients);
    const filterValue = document.getElementById('coach-filter').value;
    
    if (filterValue === 'all') {
        return activeClients;
    } else if (filterValue === 'current') {
        return activeClients.filter(client => client.assignedCoachId === currentCoachId);
    } else {
        return activeClients.filter(client => client.assignedCoachId === filterValue);
    }
}

// Enhanced loadClients function to use hybrid approach
async function loadClients() {
    const clientsList = document.getElementById('clients-list');
    if (!clientsList) return;

    // Show loading state
    clientsList.innerHTML = '<div style="text-align: center; padding: 2rem;">Loading client data...</div>';

    // Try to load real clients first
    realClients = await loadRealClientsFromDatabase();
    
    // Use real clients if available, otherwise fall back to sample clients for demonstration
    const activeClients = realClients.length > 0 ? realClients : sampleClients;
    const dataSource = realClients.length > 0 ? 'live database' : 'sample demonstration data';
    
    console.log(`Using ${dataSource} - showing ${activeClients.length} clients`);

    const filteredClients = getFilteredClients(activeClients);
    
    // Add data source indicator
    const dataSourceBanner = realClients.length > 0 ? 
        '<div style="background: #4CAF50; color: white; padding: 0.75rem; margin-bottom: 1rem; border-radius: 6px; text-align: center; font-weight: 600;">âœ… Showing Live Client Data from Automation System</div>' :
        '<div style="background: #2196F3; color: white; padding: 0.75rem; margin-bottom: 1rem; border-radius: 6px; text-align: center; font-weight: 600;">ðŸ“Š Showing Sample Data for Demonstration (No real clients yet)</div>';
    
    const clientCards = filteredClients.map(client => {
        const latestCheckIn = getLatestCheckIn(client);
        const status = getClientStatus(client, latestCheckIn);
        const anchorSummary = getAnchorSummary(latestCheckIn);
        const lastActivityText = getLastActivityText(client.lastActivity);
        const assignedCoach = availableCoaches.find(coach => coach.id === client.assignedCoachId);
        const coachName = assignedCoach ? assignedCoach.name : 'Unassigned';
        const packageInfo = getPackageDisplay(client.coachingPackage);

        // Add indicator for real vs sample clients
        const clientTypeIndicator = client.isRealClient ? 
            '<div style="font-size: 0.7rem; color: var(--success-color); margin-top: 0.25rem;">ðŸ”— Live Client</div>' : 
            '<div style="font-size: 0.7rem; color: var(--accent-color); margin-top: 0.25rem;">ðŸ“Š Demo Data</div>';

        return `
            <div class="client-card">
                <div class="client-header">
                    <div>
                        <div class="client-name">${client.name}</div>
                        <div class="client-email">${client.email}</div>
                        ${supervisorMode ? `<div style="font-size: 0.8rem; color: var(--accent-color); margin-top: 0.25rem;">Coach: ${coachName}</div>` : ''}
                        ${client.intakeBaseline ? '<div style="font-size: 0.7rem; color: var(--success-color); margin-top: 0.25rem;">âœ… Intake Complete</div>' : ''}
                        ${clientTypeIndicator}
                    </div>
                    <div class="client-status ${status.class}">${status.text}</div>
                </div>
                
                ${packageInfo}
                
                <div style="margin-bottom: 1rem;">
                    <div style="font-size: 0.85rem; opacity: 0.7;">Last Activity</div>
                    <div style="font-weight: 600;">${lastActivityText}</div>
                </div>
                
                <div class="anchor-summary">
                    ${anchorSummary}
                </div>
                
                <div class="client-actions${supervisorMode ? ' supervisor-mode' : ''}">
                    <button class="client-btn primary" onclick="openClientDetailFromCard('${client.id}')">View Progress</button>
                    <button class="client-btn modules" onclick="openModuleManagement('${client.id}')">Modules</button>
                    <button class="client-btn">Sessions</button>
                    ${supervisorMode ? `<button class="client-btn transfer" onclick="openTransferModal('${client.id}')">Transfer</button>` : ''}
                    <button class="client-btn${supervisorMode ? '' : ' full-width'}">Message</button>
                </div>
            </div>
        `;
    }).join('');

    clientsList.innerHTML = dataSourceBanner + clientCards;
    updateStats(filteredClients);
    generateEnhancedAlerts(filteredClients);
}

function updateStats(clients) {
    const totalClients = clients.length;
    const activeToday = clients.filter(client => {
        const lastActivity = new Date(client.lastActivity);
        const today = new Date();
        return lastActivity.toDateString() === today.toDateString();
    }).length;
    
    const sixWeekClients = clients.filter(client => client.coachingPackage.type === '6-week').length;
    const twelveWeekClients = clients.filter(client => client.coachingPackage.type === '12-week').length;
    
    document.getElementById('total-clients').textContent = totalClients;
    document.getElementById('active-today').textContent = activeToday;
    document.getElementById('six-week-clients').textContent = sixWeekClients;
    document.getElementById('twelve-week-clients').textContent = twelveWeekClients;
}

function getLatestCheckIn(client) {
    const dates = Object.keys(client.checkIns).sort().reverse();
    return dates.length > 0 ? client.checkIns[dates[0]] : null;
}

function getClientStatus(client, latestCheckIn) {
    if (!latestCheckIn) return { class: 'status-inactive', text: 'No Data' };
    
    const hasLowRatings = Object.values(latestCheckIn.ratings).some(rating => rating <= 2);
    return hasLowRatings ? 
        { class: 'status-concern', text: 'Needs Attention' } :
        { class: 'status-active', text: 'Active Today' };
}

function getAnchorSummary(checkIn) {
    if (!checkIn || !checkIn.ratings) {
        return '<span style="opacity: 0.5;">No recent check-ins</span>';
    }

    const anchors = [
        { key: 'physical', class: 'physical' },
        { key: 'mental', class: 'mental' }, 
        { key: 'emotional', class: 'emotional' },
        { key: 'spiritual', class: 'spiritual' },
        { key: 'relational', class: 'relational' }
    ];

    return anchors.map(anchor => {
        const rating = checkIn.ratings[anchor.key] || 0;
        const lowClass = rating <= 2 ? ' low' : '';
        return `<div class="anchor-mini ${anchor.class}${lowClass}" title="${anchor.key}: ${rating}/5">${rating}</div>`;
    }).join('');
}

function getLastActivityText(lastActivity) {
    const lastDate = new Date(lastActivity);
    const now = new Date();
    const diffHours = Math.floor((now - lastDate) / (1000 * 60 * 60));
    
    if (diffHours < 1) return 'Just now';
    if (diffHours < 24) return `${diffHours} hours ago`;
    
    const diffDays = Math.floor(diffHours / 24);
    return `${diffDays} day${diffDays === 1 ? '' : 's'} ago`;
}

function getPackageDisplay(packageInfo) {
    const progressPercentage = (packageInfo.sessionsCompleted / packageInfo.sessionsTotal) * 100;
    const packageClass = packageInfo.type === '6-week' ? 'package-6week' : 'package-12week';
    
    return `
        <div class="package-info ${packageClass}">
            <div class="package-header">
                <span class="package-type">${packageInfo.type.toUpperCase()} Package</span>
                <span class="session-progress">${packageInfo.sessionsCompleted}/${packageInfo.sessionsTotal} sessions</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: ${progressPercentage}%"></div>
            </div>
        </div>
    `;
}

// Enhanced Alert Generation with Clickable Functionality
function generateEnhancedAlerts(clients) {
    const alertsContainer = document.getElementById('alerts-container');
    if (!alertsContainer) return;

    const alerts = [];
    clients.forEach(client => {
        const latest = getLatestCheckIn(client);
        if (!latest) return;

        Object.entries(latest.ratings).forEach(([anchor, rating]) => {
            if (rating <= 2) {
                const assignedCoach = availableCoaches.find(coach => coach.id === client.assignedCoachId);
                alerts.push({
                    client: client.name,
                    clientId: client.id,
                    coach: assignedCoach?.name || 'Unassigned',
                    type: 'Low Anchor Rating',
                    details: `${anchor.charAt(0).toUpperCase() + anchor.slice(1)}: ${rating}/5`,
                    severity: rating === 1 ? 'critical' : 'warning',
                    fullClient: client
                });
            }
        });
    });

    if (alerts.length === 0) {
        alertsContainer.innerHTML = '<div class="card"><h3>No Active Alerts</h3><p>All clients showing stable patterns.</p></div>';
        return;
    }

    alertsContainer.innerHTML = alerts.map(alert => `
        <div class="alert-banner" onclick="openClientDetailFromAlert('${alert.clientId}')">
            <div class="alert-content">
                <div class="alert-title">${alert.client}${supervisorMode ? ` (Coach: ${alert.coach})` : ''} - ${alert.type}</div>
                <div class="alert-details">${alert.details}</div>
            </div>
            <div class="alert-actions">
                <button class="alert-btn" onclick="event.stopPropagation(); openModuleManagement('${alert.clientId}')">Modules</button>
                <button class="alert-btn" onclick="event.stopPropagation(); alert('Message feature coming soon')">Contact</button>
            </div>
        </div>
    `).join('');
}

// Module Management and other functions continue with existing implementations...
// [Include all the remaining functions from the original coach dashboard]

function toggleSupervisorMode() {
    const coachFilter = document.getElementById('coach-filter');
    
    if (supervisorMode) {
        coachFilter.value = 'current';
    } else {
        coachFilter.value = 'all';
    }
    
    filterClientsByCoach();
}

function initializeNavigation() {
    const navItems = document.querySelectorAll('.nav-item');
    
    navItems.forEach(item => {
        item.addEventListener('click', function() {
            const sectionName = this.getAttribute('data-section');
            if (sectionName) {
                showSection(sectionName);
            }
        });
    });
}

function initializeCoachControls() {
    const coachFilter = document.getElementById('coach-filter');
    const supervisorToggle = document.getElementById('supervisor-mode');
    
    if (coachFilter) {
        coachFilter.addEventListener('change', filterClientsByCoach);
    }
    
    if (supervisorToggle) {
        supervisorToggle.addEventListener('click', toggleSupervisorMode);
    }
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 6px;
        z-index: 1001;
        animation: slideIn 0.3s ease;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Enhanced initialization function
async function initializeCoachDashboard() {
    console.log('Initializing coach dashboard with hybrid data system...');
    
    // Initialize existing functionality
    initializeNavigation();
    initializeCoachControls();
    
    // Load clients (will check for real clients, fall back to sample)
    await loadClients();
    
    // Add refresh button
    setTimeout(addRefreshButton, 1000);
    
    console.log('Coach dashboard initialized successfully');
}

// Add refresh button with smart detection
function addRefreshButton() {
    const coachControls = document.querySelector('.coach-controls');
    if (coachControls) {
        const refreshButton = document.createElement('button');
        refreshButton.className = 'supervisor-toggle';
        refreshButton.style.background = 'var(--success-color)';
        refreshButton.textContent = 'ðŸ”„ Check for Real Clients';
        refreshButton.onclick = async function() {
            this.textContent = 'â³ Checking Database...';
            this.disabled = true;
            
            const previousCount = realClients.length;
            realClients = await loadRealClientsFromDatabase();
            await loadClients();
            
            const newCount = realClients.length;
            if (newCount > previousCount) {
                showNotification(`Found ${newCount} real clients from automation system!`, 'success');
                this.textContent = 'ðŸ”„ Refresh Live Data';
            } else if (newCount > 0) {
                showNotification('Live client data refreshed', 'success');
                this.textContent = 'ðŸ”„ Refresh Live Data';
            } else {
                showNotification('No real clients yet - still using demo data', 'info');
                this.textContent = 'ðŸ”„ Check for Real Clients';
            }
            
            this.disabled = false;
        };
        
        coachControls.appendChild(refreshButton);
    }
}

// Close modals when clicking outside
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('transfer-modal')) {
        closeTransferModal();
    }
    if (e.target.classList.contains('client-detail-modal')) {
        closeClientDetailModal();
    }
});

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    initializeCoachDashboard();
});

// Add slideIn and slideOut animations
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(style);
