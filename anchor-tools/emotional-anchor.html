<!--
  ============================================================
  Clarity Metabolics - Emotional Anchor: The Stability Well
  Interactive Web Tool for Post-Awakening Emotional Stability
  ============================================================
  
  Version: 3.1.0 (With Database Integration)
  Created: August 2025
  Author: Clarity Metabolics
  
  Description:
  8-step interactive tool to help users process intense emotions,
  distinguish feelings from reactive stories, and choose grounded responses.
  Features unique Red→Yellow→Green emotional progression and pattern recognition.
  Part of the Five Anchors framework for post-awakening support.
  
  NEW: Integrated with Supabase database for anchor statement saving
  
  Features:
  - Progressive 8-step flow with universal grounding intro
  - Red→Yellow→Green emotional deconstruction (Reactive→Recognition→Truth)
  - Body's early warning system identification
  - Pattern recognition for emotional triggers
  - Emotional Anchor Statement creation with database saving
  - Light/dark theme toggle
  - Download summary functionality
  - Meaningful reflection modal with Trinity prayer
  - Mobile responsive design
  - Progress tracking with validation
  - localStorage session persistence
  - Auto-focus and smooth scrolling
  - Database integration for anchor statements
  
  Flow:
  1. Universal grounding and settling
  2. From Reaction to Truth (Red→Yellow→Green panels)
  3. Your Body's Early Warning System
  4. What Your Core Feeling Is Protecting
  5. Spot Your Emotional Pattern (triggers and anchor statement with auto-save)
  6. Choose Your Response (honor feeling + wise action)
  7. Summary with highlighted Emotional Anchor Statement
  8. Next Steps: Spiritual Anchor introduction
  
  Usage:
  Standalone HTML file - requires supabase-config.js for database functionality
  Open in any modern web browser
  
  License: © 2025 Clarity Metabolics
  Website: https://claritymetabolics.com
  ============================================================
-->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Emotional Anchor — The Stability Well</title>
<link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Libre+Baskerville:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root{
    --main-color:#C97D7D;      /* primary (bar/buttons) */
    --accent-color:#F5EAE6;    /* soft panels */
    --contrast-color:#5A3E3E;  /* deep accent text/borders */
    --text-color:#333;
    --bg-color:#fff;
    --border-color:#e6d3cf;
    --shadow:0 2px 12px rgba(0,0,0,.08);
    --success-color:#5a7c41;   /* progress dots done */
    --warning-color:#dc3545;   /* Start Over confirm */
    --green-panel:#E5EBDD;
    --yellow-panel:#FFF8CC;
    --red-panel:#F5E6E6;
  }
  [data-theme="dark"]{
    --text-color:#e6e6e6;
    --bg-color:#1c1c1c;
    --border-color:#423532;
    --accent-color:#2d2625;
    --shadow:0 2px 14px rgba(0,0,0,.35);
    --green-panel:#2d352a;
    --yellow-panel:#3a3620;
    --red-panel:#3a2828;
  }

  *{box-sizing:border-box;margin:0;padding:0}
  body{
    font-family:'Open Sans',sans-serif;
    color:var(--text-color);
    background:var(--bg-color);
    line-height:1.6;
  }
  .container{max-width:780px;margin:0 auto;min-height:100vh;display:flex;flex-direction:column}

  /* Header */
  .header{
    color:#fff;
    background:linear-gradient(135deg,var(--main-color),var(--contrast-color));
    padding:22px 18px 18px;
    position:relative;
    transition: box-shadow .5s ease;
  }
  .header.completed{ box-shadow:0 0 18px rgba(201,125,125,.55); }
  .header h1{
    font-family:'Libre Baskerville',serif;
    font-size:2rem;
    text-align:center;
    margin-bottom:6px;
  }
  .subtitle{ text-align:center; font-style:italic; opacity:.95; }

  .header-controls{ position:absolute; top:10px; right:10px; display:flex; gap:8px }
  .header-btn{
    background:rgba(255,255,255,.15);
    border:1px solid rgba(255,255,255,.3);
    color:#fff;
    padding:.35rem .6rem;border-radius:18px;cursor:pointer;
    font-size:.8rem;transition:all .2s ease;
  }
  .header-btn:hover{background:rgba(255,255,255,.25)}

  .progress-bar{height:4px;background:rgba(255,255,255,.28);border-radius:3px;margin-top:14px;overflow:hidden}
  .progress-fill{height:100%;background:#fff;width:0%;transition:width .6s ease}

  /* Content & steps */
  main.content{flex:1;padding:22px}
  .step{display:none;animation:fade .25s ease}
  .step.active{display:block}
  @keyframes fade{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}

  .step-indicator{ text-align:center; margin:10px 0 18px }
  .step-counter{font-weight:700;color:#ffffff; background:var(--contrast-color); display:inline-block; padding:4px 10px; border-radius:12px }
  .dots{display:flex;justify-content:center;gap:8px;margin-top:10px}
  .dot{width:12px;height:12px;border-radius:50%;background:var(--border-color)}
  .dot.active{background:var(--main-color)}
  .dot.done{background:var(--success-color)}

  h2{font-family:'Libre Baskerville',serif;color:var(--main-color);font-size:1.7rem;margin:14px 0 10px}
  p.lead{opacity:.95;margin-bottom:10px}

  .tip{
    background:linear-gradient(135deg, rgba(201,125,125,.12), rgba(90,62,62,.06));
    border-left:4px solid var(--main-color);
    padding:12px;border-radius:0 8px 8px 0;margin:14px 0;font-style:italic
  }

  .form-group{margin:16px 0}
  label{display:block;font-weight:700;color:var(--contrast-color);margin-bottom:6px}
  textarea, input[type="text"]{
    width:100%;min-height:110px;resize:vertical;border:2px solid var(--border-color);
    border-radius:10px;padding:12px;font:inherit;color:inherit;background:var(--bg-color);
    transition:all .2s ease;
  }
  input[type="text"]{ min-height:auto; }
  textarea:focus, input[type="text"]:focus{
    outline:none;border-color:var(--main-color);box-shadow:0 0 0 3px rgba(201,125,125,.18)
  }

  /* Panels for G/Y/R */
  .panel{
    border:2px solid var(--border-color);
    border-radius:10px;
    padding:12px;
    margin-bottom:16px;
  }
  .panel h3{
    font-family:'Libre Baskerville',serif;
    font-size:1.1rem;
    margin-bottom:8px;
    color:var(--contrast-color);
  }

  /* Buttons */
  .nav-row{display:flex;gap:12px;align-items:center;margin-top:22px;padding-top:18px;border-top:1px solid var(--border-color)}
  .nav-row .btn{flex:1}
  .btn{
    border:none;border-radius:10px;padding:14px 18px;font-weight:700;cursor:pointer;
    transition:transform .1s ease, background .2s ease, box-shadow .2s ease;
  }
  .btn-primary{background:var(--main-color);color:#fff}
  .btn-primary:hover{background:var(--contrast-color);box-shadow:var(--shadow);transform:translateY(-1px)}
  .btn-secondary{background:var(--accent-color);color:var(--contrast-color);border:1px solid var(--border-color)}
  .btn-secondary:hover{background:var(--border-color)}
  .btn-warning{background:var(--warning-color);color:#fff}
  .btn-warning:hover{background:#c82333}

  .micro{ text-align:center; margin-top:6px; font-style:italic; color:var(--contrast-color); opacity:.85 }

  /* Final actions + Next Phase CTA */
  .final-actions{
    display:flex; flex-direction:column; align-items:center; gap:12px; margin:18px 0; width:100%;
  }
  .final-actions .btn{ display:block; width:100%; max-width:280px; min-height:50px; text-align:center; }

  .next-phase {
    margin-top: 22px;
    padding: 16px;
    background: var(--accent-color);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    text-align: center;
    box-shadow: var(--shadow);
  }
  .next-phase .lead {
    font-family: 'Libre Baskerville', serif;
    font-size: 1.05rem;
    color: var(--contrast-color);
    margin-bottom: 10px;
  }
  .next-phase .sub {
    font-size: 0.9rem;
    opacity: 0.9;
    margin-top: 6px;
  }
  .next-phase .btn-next {
    margin-top: 10px;
    display: inline-block;
    padding: 12px 18px;
    border-radius: 10px;
    font-weight: 700;
    border: none;
    cursor: pointer;
    background: var(--main-color);
    color: #fff;
    transition: transform .1s ease, background .2s ease, box-shadow .2s ease;
  }
  .next-phase .btn-next:hover {
    background: var(--contrast-color);
    box-shadow: var(--shadow);
    transform: translateY(-1px);
  }

  /* Branding */
  .branding{ text-align:center; padding:18px; font-size:.85rem; color:var(--text-color); opacity:.75; border-top:1px solid var(--border-color) }
  .branding a{ color:var(--contrast-color); text-decoration:none }
  .branding a:hover{ text-decoration:underline }

  .scripture{font-style:italic;background:var(--accent-color);padding:16px;border-left:4px solid var(--main-color);border-radius:8px;margin:16px 0}

  /* NEW: Database save indicator */
  .save-indicator{
    display:inline-flex;align-items:center;gap:6px;font-size:0.8rem;color:var(--success-color);
    opacity:0;transition:opacity .3s ease;margin-top:6px;
  }
  .save-indicator.show{opacity:1}

  @media (max-width:640px){
    .nav-row{flex-direction:column}
    .btn{width:100%}
  }

  @media (prefers-reduced-motion: reduce) {
    .step { animation: none; }
    .progress-fill { transition: none; }
    .btn { transition: none; }
  }
</style>
</head>
<body>
<div id="pageTop" style="position:absolute;top:0"></div>
<div class="container">

  <header class="header" id="mainHeader">
    <div class="header-controls">
      <button class="header-btn" id="themeBtn" aria-label="Toggle light and dark theme" title="Toggle theme">🌙</button>
    </div>
    <h1>Emotional Anchor — The Stability Well</h1>
    <p class="subtitle">🪣 Ground your emotions and respond from inner stability.</p>
    <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
  </header>

  <main class="content">
    <!-- STEP 0: Welcome -->
    <section class="step active" data-step="0">
      <div class="step-indicator">
        <div class="step-counter">Step 1 of 8</div>
        <div class="dots"><div class="dot active"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
      </div>
      <h2>Welcome to Your Emotional Anchor</h2>
      <p class="lead">Like drawing from a deep well of inner stability, this space helps you process intense emotions with compassion and wisdom, transforming overwhelming feelings into clear, purposeful action. That's what this tool is here to help you with. Take a few deep, full breaths to settle in. When you're ready, let's begin.</p>
      <div class="nav-row"><button class="btn btn-primary" onclick="nextStep()">Begin</button></div>
      <div class="micro">Take your time. There's no rush here.</div>
      <div class="branding">© 2025 Clarity Metabolics | <a href="https://claritymetabolics.com" target="_blank">claritymetabolics.com</a></div>
    </section>

    <!-- STEP 1: Name What You're Feeling (structured panels) -->
    <section class="step" data-step="1">
      <div class="step-indicator">
        <div class="step-counter">Step 2 of 8</div>
        <div class="dots"><div class="dot done"></div><div class="dot active"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
      </div>
      <h2>From Reaction to Truth</h2>
      <p class="lead">Distinguishing core emotions from reactive stories helps you respond rather than react. Take a moment to scan your emotional landscape right now.</p>

      <div class="form-group">
        <label for="emotionInput"><strong>What emotion feels strongest for you right now?</strong></label>
        <p style="font-size:0.9rem;font-style:italic;color:var(--contrast-color);opacity:0.8;margin:0 0 12px 0">Describe what you're feeling without judgment</p>
        <textarea id="emotionInput" placeholder="I'm feeling _____ about _____" rows="3"></textarea>
      </div>

      <div class="form-group panel" style="background:var(--red-panel)">
        <h3>Reactive Story — What's your first emotional response?</h3>
        <p style="font-size:0.9rem;font-style:italic;color:var(--contrast-color);opacity:0.8;margin:0 0 12px 0">The surface emotion that matches the story you're telling yourself about this situation</p>
        <textarea id="reactiveStory" placeholder="I'm angry because... I'm frustrated that... I'm disappointed about..." rows="3"></textarea>
      </div>

      <div class="form-group panel" style="background:var(--yellow-panel)">
        <h3>Something's Not Quite Right — What feels incomplete about that response?</h3>
        <p style="font-size:0.9rem;font-style:italic;color:var(--contrast-color);opacity:0.8;margin:0 0 12px 0">Notice where your first response feels too simple or like there's more beneath the surface</p>
        <textarea id="somethingOff" placeholder="This feels like only part of the story... There's something deeper... I also feel..." rows="3"></textarea>
      </div>

      <div class="form-group panel" style="background:var(--green-panel)">
        <h3>Core Feeling — What's the purest emotion underneath?</h3>
        <p style="font-size:0.9rem;font-style:italic;color:var(--contrast-color);opacity:0.8;margin:0 0 12px 0">Strip away the story and find the foundational emotion driving this situation</p>
        <textarea id="coreFeeling" placeholder="Fear, sadness, grief, shame, loneliness, excitement, love... what's the raw emotion?" rows="3"></textarea>
      </div>

      <div class="tip"><strong>Micro-practice:</strong> Consider: anger, fear, sadness, joy, shame, excitement, grief, hope, disgust, love. Place your hand on your heart. Say: "I feel [core emotion] and that's okay."</div>

      <div class="nav-row">
        <button class="btn btn-secondary" onclick="prevStep()">← Back</button>
        <button class="btn btn-primary" id="saveEmotionStep" onclick="nextStep()" disabled>Complete Emotional Check-in to Continue</button>
      </div>
      <div class="micro">Naming emotions reduces their intensity.</div>
      <div class="branding">© 2025 Clarity Metabolics | claritymetabolics.com</div>
    </section>

    <!-- STEP 2: Your Body's Early Warning System -->
    <section class="step" data-step="2">
      <div class="step-indicator">
        <div class="step-counter">Step 3 of 8</div>
        <div class="dots"><div class="dot done"></div><div class="dot done"></div><div class="dot active"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
      </div>
      <h2>Your Body's Early Warning System</h2>
      <p class="lead">Your body often knows you're heading toward reactivity before your mind does. Learning to read these signals helps you catch patterns before they take over.</p>

      <div class="form-group">
        <label for="bodySignals">What signals was your body sending before you went into reactive mode?</label>
        <p style="font-size:0.9rem;font-style:italic;color:var(--contrast-color);opacity:0.8;margin:0 0 12px 0">Think back to the moments before the reaction. What physical sensations were present?</p>
        <textarea id="bodySignals" placeholder="Chest tightening, shoulders tensing, stomach dropping, jaw clenching, breathing shallow..."></textarea>
      </div>

      <div class="form-group">
        <label for="bodyWarning">What was your body trying to warn you about?</label>
        <p style="font-size:0.9rem;font-style:italic;color:var(--contrast-color);opacity:0.8;margin:0 0 12px 0">Your body's signals often point to what you need to protect or what feels unsafe</p>
        <textarea id="bodyWarning" placeholder="Boundary being crossed, feeling unsafe, being overwhelmed, needing space..."></textarea>
      </div>

      <div class="tip"><strong>Micro-practice:</strong> Your body is always sending you information. The key is learning to listen before the reaction takes over.</div>

      <div class="nav-row">
        <button class="btn btn-secondary" onclick="prevStep()">← Back</button>
        <button class="btn btn-primary" onclick="nextStep()">What It's Protecting →</button>
      </div>
      <div class="micro">Your body is your wisest advisor.</div>
      <div class="branding">© 2025 Clarity Metabolics | claritymetabolics.com</div>
    </section>

    <!-- STEP 3: What It's Protecting -->
    <section class="step" data-step="3">
      <div class="step-indicator">
        <div class="step-counter">Step 4 of 8</div>
        <div class="dots"><div class="dot done"></div><div class="dot done"></div><div class="dot done"></div><div class="dot active"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
      </div>
      <h2>What Your Core Feeling Is Protecting</h2>
      <p class="lead">Your emotions aren't random - Not only are they signals and clues to point you to truth (if we interpret them wisely) they're protective responses to threats against what you value most. Fear protects safety, anger protects boundaries, sadness protects connection.</p>
      
      <div class="form-group">
        <label for="emotionProtecting">What Value Is The Core Feeling You Identified In Step 2 Protecting? — What does this foundational emotion care about?</label>
        <p style="font-size:0.9rem;font-style:italic;color:var(--contrast-color);opacity:0.8;margin:0 0 12px 0">Looking at the core feeling you identified, what precious value is it trying to guard?</p>
        <textarea id="emotionProtecting" placeholder="What important value or need is this core emotion defending?"></textarea>
      </div>

      <div class="form-group">
        <label for="emotionWisdom">What Truth is Your Core Feeling Revealing — What is this foundational emotion trying to tell you?</label>
        <p style="font-size:0.9rem;font-style:italic;color:var(--contrast-color);opacity:0.8;margin:0 0 12px 0">Honor the messenger of your core feeling, even if you don't follow all its suggestions</p>
        <textarea id="emotionWisdom" placeholder="What is this core emotion trying to tell you about your situation or needs?"></textarea>
      </div>

      <div class="tip"><strong>Micro-practice:</strong> Even difficult emotions guard what you value most. Can you feel grateful that something in you cares so deeply about protecting what matters?</div>

      <div class="nav-row">
        <button class="btn btn-secondary" onclick="prevStep()">← Back</button>
        <button class="btn btn-primary" onclick="nextStep()">Spot the Pattern →</button>
      </div>
      <div class="micro">Emotions are allies, not enemies.</div>
      <div class="branding">© 2025 Clarity Metabolics | claritymetabolics.com</div>
    </section>

    <!-- STEP 4: NEW - Spot the Pattern with Database Integration -->
    <section class="step" data-step="4">
      <div class="step-indicator">
        <div class="step-counter">Step 5 of 8</div>
        <div class="dots"><div class="dot done"></div><div class="dot done"></div><div class="dot done"></div><div class="dot done"></div><div class="dot active"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
      </div>
      <h2>Spot Your Emotional Pattern</h2>
      <p class="lead">Your emotions often follow familiar patterns. Recognizing these patterns helps you respond with more wisdom and compassion, breaking cycles that keep you stuck or just aren't helping you anymore.</p>

      <div class="form-group">
        <label for="emotionalPattern">Beyond the situation from Step 2, when else have you felt this core feeling?</label>
        <p style="font-size:0.9rem;font-style:italic;color:var(--contrast-color);opacity:0.8;margin:0 0 12px 0">Consider similar relationships, conflicts, or life circumstances where this pattern shows up</p>
        <textarea id="emotionalPattern" placeholder="Times of conflict, stress, rejection, disappointment, similar triggers..."></textarea>
      </div>

      <div class="form-group">
        <label for="emotionalTriggers">In hindsight, can you see the early emotional warning signs you had before these situations developed?</label>
        <p style="font-size:0.9rem;font-style:italic;color:var(--contrast-color);opacity:0.8;margin:0 0 12px 0">The first signals that tell you an emotional storm might be brewing</p>
        <textarea id="emotionalTriggers" placeholder="Irritability, withdrawal, overthinking, physical tension, sensitivity..."></textarea>
      </div>

      <div class="form-group">
        <label for="emotionalAnchorStatement">Your Emotional Anchor Statement — What truth about your emotions will you remember?</label>
        <p style="font-size:0.9rem;font-style:italic;color:var(--contrast-color);opacity:0.8;margin:0 0 12px 0">A simple truth about honoring your emotions that you can return to when overwhelmed</p>
        <textarea id="emotionalAnchorStatement" placeholder="Even when emotions feel overwhelming, I can..."></textarea>
        <div class="save-indicator" id="anchorSaveIndicator">
          <span>✓</span> Anchor statement saved automatically
        </div>
      </div>

      <div class="tip"><strong>Micro-practice:</strong> Read your emotional anchor statement once aloud, slowly. Let this truth settle into your heart.</div>

      <div class="nav-row">
        <button class="btn btn-secondary" onclick="prevStep()">← Back</button>
        <button class="btn btn-primary" onclick="nextStep()">Choose Response →</button>
      </div>
      <div class="micro">Patterns once seen can be gently changed.</div>
      <div class="branding">© 2025 Clarity Metabolics | claritymetabolics.com</div>
    </section>

    <!-- STEP 5: Choose Your Response -->
    <section class="step" data-step="5">
      <div class="step-indicator">
        <div class="step-counter">Step 6 of 8</div>
        <div class="dots"><div class="dot done"></div><div class="dot done"></div><div class="dot done"></div><div class="dot done"></div><div class="dot done"></div><div class="dot active"></div><div class="dot"></div><div class="dot"></div></div>
      </div>
      <h2>Choose Your Response</h2>
      <p class="lead">You can honor your feelings while choosing wise actions.</p>

      <div class="form-group">
        <label for="honorFeeling">Honor the Feeling — How can you validate this emotion without reactive actions?</label>
        <p style="font-size:0.9rem;font-style:italic;color:var(--contrast-color);opacity:0.8;margin:0 0 12px 0">Feel it fully, express it safely, or simply acknowledge its presence</p>
        <textarea id="honorFeeling" placeholder="Journal, cry, move your body, talk to a trusted friend, create art..."></textarea>
      </div>

      <div class="form-group">
        <label for="wiseAction">Wise Action — What response honors both your values and your wisdom?</label>
        <p style="font-size:0.9rem;font-style:italic;color:var(--contrast-color);opacity:0.8;margin:0 0 12px 0">Choose actions that align with your deeper truth, not just immediate impulses</p>
        <textarea id="wiseAction" placeholder="What would your wisest, most grounded self do in this situation?"></textarea>
      </div>

      <div class="tip"><strong>Micro-practice:</strong> Ask: "How can I honor what this emotion is protecting while choosing my wisest response?"</div>

      <div class="nav-row">
        <button class="btn btn-secondary" onclick="prevStep()">← Back</button>
        <button class="btn btn-primary" onclick="nextStep()">Your Summary →</button>
      </div>
      <div class="micro">Wise responses create lasting peace.</div>
      <div class="branding">© 2025 Clarity Metabolics | claritymetabolics.com</div>
    </section>

    <!-- STEP 6: Summary -->
    <section class="step" data-step="6">
      <div class="step-indicator">
        <div class="step-counter">Step 7 of 8</div>
        <div class="dots"><div class="dot done"></div><div class="dot done"></div><div class="dot done"></div><div class="dot done"></div><div class="dot done"></div><div class="dot done"></div><div class="dot active"></div><div class="dot"></div></div>
      </div>
      <h2>Your Stability Well Summary</h2>
      <p>You named your emotions, honored your body's wisdom, discovered what you're protecting, recognized your patterns, and chose a grounded response. You've transformed emotional overwhelm into stable, wise action.</p>

      <div style="background:var(--accent-color);padding:16px;border-radius:10px;margin:12px 0">
        <h3 style="font-family:'Libre Baskerville',serif;color:var(--contrast-color)">From Reaction to Truth</h3>
        <p id="sumEmotions">—</p>

        <h3 style="font-family:'Libre Baskerville',serif;color:var(--contrast-color);margin-top:10px">Your Body's Early Warning System</h3>
        <p id="sumBody">—</p>

        <h3 style="font-family:'Libre Baskerville',serif;color:var(--contrast-color);margin-top:10px">What Your Core Feeling Is Protecting</h3>
        <p id="sumProtecting">—</p>

        <h3 style="font-family:'Libre Baskerville',serif;color:var(--contrast-color);margin-top:10px">Spot Your Emotional Pattern</h3>
        <p id="sumPatterns">—</p>

        <h3 style="font-family:'Libre Baskerville',serif;color:var(--contrast-color);margin-top:10px">Choose Your Response</h3>
        <p id="sumResponse">—</p>
      </div>

      <!-- Emotional Anchor Statement Highlight -->
      <div style="background:linear-gradient(135deg,var(--main-color),var(--contrast-color));color:#fff;padding:20px;border-radius:12px;margin:20px 0;text-align:center;box-shadow:var(--shadow)">
        <h3 style="font-family:'Libre Baskerville',serif;font-size:1.2rem;margin-bottom:12px;opacity:0.9">Your Emotional Anchor Statement</h3>
        <p id="emotionalAnchorHighlight" style="font-family:'Libre Baskerville',serif;font-size:1.1rem;font-style:italic;line-height:1.6">—</p>
        <p style="font-size:0.85rem;margin-top:10px;opacity:0.8">Your truth to return to when emotions feel overwhelming</p>
      </div>

      <div class="final-actions">
        <button class="btn btn-primary" onclick="downloadSummary()">📄 Download Summary</button>
        <button class="btn btn-secondary" onclick="openMeaningfulReflection()">✨ Meaningful Reflection</button>
      </div>

      <div style="display:flex; flex-direction:column; align-items:center; gap:12px; margin:18px 0; width:100%;">
        <button class="btn btn-secondary" style="display:block; width:100%; max-width:280px; min-height:50px; text-align:center;" onclick="prevStep()">← Back</button>
        <button class="btn btn-primary" style="display:block; width:100%; max-width:280px; min-height:50px; text-align:center;" onclick="nextStep()">Next Steps →</button>
      </div>

      <div class="branding">© 2025 Clarity Metabolics | claritymetabolics.com</div>
    </section>

    <!-- STEP 7: Next Steps - Spiritual Anchor lead-in -->
    <section class="step" data-step="7">
      <div class="step-indicator">
        <div class="step-counter">Step 8 of 8</div>
        <div class="dots"><div class="dot done"></div><div class="dot done"></div><div class="dot done"></div><div class="dot done"></div><div class="dot done"></div><div class="dot done"></div><div class="dot done"></div><div class="dot active"></div></div>
      </div>
      <h2>Your Next Anchor: Spiritual</h2>
      <p class="lead">Now that your emotions are stable and you're responding from wisdom rather than reactivity, let's strengthen your connection to what's eternal and unchanging.</p>

      <div class="next-phase" aria-label="Move to Spiritual Anchor">
        <div class="lead"><strong>Carry your emotional stability into sacred connection.</strong></div>
        <button class="btn-next" onclick="returnToDashboard()">→ Return to Five Anchors Dashboard</button>
        <div class="sub">Connect with the Trinity from a place of inner peace and emotional groundedness.</div>
      </div>

      <div style="display:flex; flex-direction:column; align-items:center; gap:12px; margin:22px 0; width:100%;">
        <button class="btn btn-secondary" style="display:block; width:100%; max-width:280px; min-height:50px; text-align:center;" onclick="prevStep()">← Back</button>
        <button class="btn btn-secondary" id="startOverBtn" style="display:block; width:100%; max-width:280px; min-height:50px; text-align:center;" onclick="confirmStartOver()">🔄 Start Over</button>
      </div>

      <div class="branding">
        <div><strong>Created by Clarity Metabolics</strong></div>
        <div style="font-style:italic;margin-top:4px">Quiet the world. Reconnect with what's real.</div>
        <div><a href="https://claritymetabolics.com" target="_blank">claritymetabolics.com</a></div>
      </div>
    </section>
  </main>
</div>

<!-- Meaningful Reflection Modal -->
  <div id="meaningfulModal" style="position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px;z-index:1000">
  <div style="background:var(--bg-color);color:var(--text-color);max-width:560px;width:100%;max-height:90vh;border-radius:12px;box-shadow:var(--shadow);padding:22px;overflow-y:auto">
    <h3 style="font-family:'Libre Baskerville',serif;color:var(--main-color);margin-bottom:8px">Meaningful Reflection</h3>
    <div class="scripture" style="margin:10px 0 16px 0">
      <div style="margin-bottom:24px">
        <p style="font-size:1.1rem;font-weight:700;color:var(--main-color);margin-bottom:8px">FATHER</p>
        <p style="margin-left:16px;line-height:1.7">Help me feel my emotions without being overwhelmed by them. Grant me wisdom to honor what they protect while choosing responses that align with Your heart.</p>
      </div>
      
      <div style="margin-bottom:24px">
        <p style="font-size:1.1rem;font-weight:700;color:var(--main-color);margin-bottom:8px">SON</p>
        <p style="margin-left:16px;line-height:1.7">Jesus, You felt the full range of human emotion - joy, sorrow, anger, compassion. Teach me to follow Your example of feeling deeply while responding wisely.</p>
      </div>
      
      <div style="margin-bottom:24px">
        <p style="font-size:1.1rem;font-weight:700;color:var(--main-color);margin-bottom:8px">HOLY SPIRIT</p>
        <p style="margin-left:16px;line-height:1.7">Spirit, guide my heart to peace and my actions to love. Help me discern between emotions that serve and reactions that harm.</p>
      </div>
      
      <p style="margin-top:28px;font-style:italic;text-align:center;opacity:0.9">✨ <strong>"Be angry and do not sin; do not let the sun go down on your anger." — Ephesians 4:26</strong></p>
    </div>
    <div style="text-align:center">
      <button class="btn btn-primary" onclick="closeMeaningfulReflection()">Amen</button>
    </div>
  </div>
</div>

<script type="module">
  // Import database functionality
  import { hybridDataManager, showNotification } from '../dashboard/js/supabase-config.js';

  // --- State
  let currentStep = 0;
  const totalSteps = 8;
  const responses = {
    emotionInput:'', reactiveStory:'', somethingOff:'', coreFeeling:'',
    bodySignals:'', bodyWarning:'',
    emotionProtecting:'', emotionWisdom:'',
    emotionalPattern:'', emotionalTriggers:'', emotionalAnchorStatement:'',
    honorFeeling:'', wiseAction:''
  };

  // Database connection flag
  let dbConnected = false;

  // Light / Dark toggle
  document.getElementById('themeBtn').addEventListener('click', () => {
    const body = document.body;
    const btn = document.getElementById('themeBtn');
    if (body.getAttribute('data-theme') === 'dark') {
      body.removeAttribute('data-theme'); btn.textContent = '🌙';
    } else {
      body.setAttribute('data-theme','dark'); btn.textContent = '☀️';
    }
  });

  // Database connection test
  async function testDatabaseConnection() {
    try {
      // Test if we can access the database
      const result = await hybridDataManager.getAnchorStatements();
      dbConnected = !result.error;
      console.log('Database connection:', dbConnected ? 'Connected' : 'Using localStorage backup');
    } catch (error) {
      console.log('Database connection: Using localStorage backup');
      dbConnected = false;
    }
  }

  // Save anchor statement to database
  async function saveAnchorStatementToDB(statementText) {
    if (!statementText || statementText.trim().length === 0) return;

    const statementData = {
      anchor_type: 'emotional',
      statement_text: statementText.trim(),
      shared_with_coach: false
    };

    try {
      const result = await hybridDataManager.saveAnchorStatement(statementData);
      
      if (!result.error) {
        // Show success indicator
        const indicator = document.getElementById('anchorSaveIndicator');
        if (indicator) {
          indicator.classList.add('show');
          setTimeout(() => indicator.classList.remove('show'), 3000);
        }
        
        showNotification('Emotional anchor statement saved', 'success');
        console.log('Anchor statement saved successfully');
      } else {
        console.log('Anchor statement saved to localStorage backup');
      }
    } catch (error) {
      console.error('Error saving anchor statement:', error);
      showNotification('Saved locally (database unavailable)', 'info');
    }
  }

  // Step navigation helpers
  function showStep(i){
    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
    const stepEl = document.querySelector(`.step[data-step="${i}"]`);
    if (stepEl) stepEl.classList.add('active');

    document.getElementById('progressFill').style.width = ((i)/ (totalSteps-1)) * 100 + '%';
    document.querySelectorAll('.step .dots').forEach(group => {
      [...group.children].forEach((d, idx) => {
        d.classList.remove('active','done');
        if (idx < i) d.classList.add('done');
        if (idx === i) d.classList.add('active');
      });
    });

    requestAnimationFrame(()=>{
      document.getElementById('pageTop').scrollIntoView({behavior:'smooth',block:'start'});
      setTimeout(()=>{
        if (i===1) document.getElementById('emotionInput')?.focus();
        if (i===2) document.getElementById('bodySignals')?.focus();
        if (i===3) document.getElementById('emotionProtecting')?.focus();
        if (i===4) document.getElementById('emotionalPattern')?.focus();
        if (i===5) document.getElementById('honorFeeling')?.focus();
      },150);
    });

    if (i===6){ document.getElementById('mainHeader')?.classList.add('completed'); updateSummary(); }
  }

  function nextStep(){ saveCurrent(); if (currentStep < totalSteps-1){ currentStep++; showStep(currentStep); } }
  function prevStep(){ if (currentStep>0){ currentStep--; showStep(currentStep);} }

  // Save per-step with anchor statement database integration
  async function saveCurrent(){
    switch(currentStep){
      case 1:
        responses.emotionInput = document.getElementById('emotionInput').value.trim();
        responses.reactiveStory = document.getElementById('reactiveStory').value.trim();
        responses.somethingOff = document.getElementById('somethingOff').value.trim();
        responses.coreFeeling = document.getElementById('coreFeeling').value.trim();
        break;
      case 2:
        responses.bodySignals = document.getElementById('bodySignals').value.trim();
        responses.bodyWarning = document.getElementById('bodyWarning').value.trim();
        break;
      case 3:
        responses.emotionProtecting = document.getElementById('emotionProtecting').value.trim();
        responses.emotionWisdom = document.getElementById('emotionWisdom').value.trim();
        break;
      case 4:
        responses.emotionalPattern = document.getElementById('emotionalPattern').value.trim();
        responses.emotionalTriggers = document.getElementById('emotionalTriggers').value.trim();
        responses.emotionalAnchorStatement = document.getElementById('emotionalAnchorStatement').value.trim();
        
        // Save anchor statement to database when Step 5 is completed
        if (responses.emotionalAnchorStatement) {
          await saveAnchorStatementToDB(responses.emotionalAnchorStatement);
        }
        break;
      case 5:
        responses.honorFeeling = document.getElementById('honorFeeling').value.trim();
        responses.wiseAction = document.getElementById('wiseAction').value.trim();
        break;
    }
    // Save to localStorage
    try {
      localStorage.setItem('emotionalAnchorResponses', JSON.stringify(responses));
    } catch (e) {
      console.warn('Could not save to localStorage:', e);
    }
  }

  // Auto-save anchor statement when user types
  function setupAnchorStatementAutoSave() {
    const anchorInput = document.getElementById('emotionalAnchorStatement');
    if (anchorInput) {
      let saveTimeout;
      anchorInput.addEventListener('input', () => {
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(async () => {
          const statement = anchorInput.value.trim();
          if (statement.length > 10) { // Only save if substantial content
            await saveAnchorStatementToDB(statement);
          }
        }, 2000); // Wait 2 seconds after user stops typing
      });
    }
  }

  // Summary
  function updateSummary(){
    const emotionsHTML = [
      '<strong>Original Emotion:</strong> ' + (responses.emotionInput || '—'),
      '<strong>Reactive Story:</strong> ' + (responses.reactiveStory || '—'),
      '<strong>Something\'s Not Quite Right:</strong> ' + (responses.somethingOff || '—'),
      '<strong>Core Feeling:</strong> ' + (responses.coreFeeling || '—')
    ].join('<br>');

    const patterns = [
      responses.emotionalPattern ? 'When felt before: ' + responses.emotionalPattern : '',
      responses.emotionalTriggers ? 'Early warning signs: ' + responses.emotionalTriggers : ''
    ].filter(Boolean).join(' | ') || 'No patterns noted.';

    document.getElementById('sumEmotions').innerHTML = emotionsHTML;
    document.getElementById('sumBody').innerHTML = [
      '<strong>Body Signals:</strong> ' + (responses.bodySignals || '—'),
      '<strong>Body Warning:</strong> ' + (responses.bodyWarning || '—')
    ].join('<br>');

    document.getElementById('sumProtecting').innerHTML = [
      '<strong>Value Being Protected:</strong> ' + (responses.emotionProtecting || '—'),
      '<strong>Emotional Wisdom:</strong> ' + (responses.emotionWisdom || '—')
    ].join('<br>');

    document.getElementById('sumPatterns').textContent = patterns;

    document.getElementById('sumResponse').innerHTML = [
      '<strong>Honor the Feeling:</strong> ' + (responses.honorFeeling || '—'),
      '<strong>Wise Action:</strong> ' + (responses.wiseAction || '—')
    ].join('<br>');
    
    // Update highlighted emotional anchor statement
    document.getElementById('emotionalAnchorHighlight').textContent = responses.emotionalAnchorStatement || 'Your emotional anchor statement will appear here';
  }

  // Return to dashboard
  function returnToDashboard() {
    // Check if we're already on the dashboard to avoid reload
    if (!window.location.pathname.includes('index.html')) {
      window.location.href = '../dashboard/index.html';
    }
  }

  // Start Over confirm
  let startOverArmed = false;
  function confirmStartOver(){
    const btn = document.getElementById('startOverBtn');
    if (!startOverArmed){
      startOverArmed = true;
      btn.classList.remove('btn-secondary'); btn.classList.add('btn-warning');
      btn.textContent = 'Confirm Start Over';
      setTimeout(()=>{ if(startOverArmed){
        startOverArmed=false; btn.classList.remove('btn-warning'); btn.classList.add('btn-secondary'); btn.textContent='🔄 Start Over';
      }},3000);
    } else { restartTool(); }
  }

  function restartTool(){
    Object.keys(responses).forEach(k => responses[k] = '');
    document.querySelectorAll('textarea, input[type="text"]').forEach(t => t.value='');
    const btn = document.getElementById('startOverBtn');
    if (btn){ startOverArmed=false; btn.className='btn btn-secondary'; btn.textContent='🔄 Start Over'; }
    const saveBtn = document.getElementById('saveEmotionStep'); if (saveBtn) saveBtn.disabled = true;
    try {
      localStorage.removeItem('emotionalAnchorResponses');
    } catch (e) {
      console.warn('Could not clear localStorage:', e);
    }
    currentStep = 0; showStep(currentStep);
  }

  // Download summary
  function downloadSummary(){
    const lines = [
      'Emotional Anchor — The Stability Well (Session Summary)',
      'Generated: ' + new Date().toLocaleString(),
      '',
      'EMOTIONAL ANCHOR STATEMENT:',
      responses.emotionalAnchorStatement || 'None noted',
      '',
      'FROM REACTION TO TRUTH:',
      'Original Emotion: ' + (responses.emotionInput || '—'),
      'Reactive Story: ' + (responses.reactiveStory || '—'),
      'Something\'s Not Quite Right: ' + (responses.somethingOff || '—'),
      'Core Feeling: ' + (responses.coreFeeling || '—'),
      '',
      'YOUR BODY\'S EARLY WARNING SYSTEM:',
      'Body Signals: ' + (responses.bodySignals || '—'),
      'Body Warning: ' + (responses.bodyWarning || '—'),
      '',
      'WHAT YOUR CORE FEELING IS PROTECTING:',
      'Value Being Protected: ' + (responses.emotionProtecting || '—'),
      'Emotional Wisdom: ' + (responses.emotionWisdom || '—'),
      '',
      'SPOT YOUR EMOTIONAL PATTERN:',
      'When felt before: ' + (responses.emotionalPattern || '—'),
      'Early warning signs: ' + (responses.emotionalTriggers || '—'),
      '',
      'CHOOSE YOUR RESPONSE:',
      'Honor the Feeling: ' + (responses.honorFeeling || '—'),
      'Wise Action: ' + (responses.wiseAction || '—'),
      '',
      '— © 2025 Clarity Metabolics | claritymetabolics.com'
    ].join('\n');

    const blob = new Blob([lines],{type:'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href=url; a.download='emotional-anchor-stability-well-summary.txt';
    document.body.appendChild(a); a.click();
    document.body.removeChild(a); URL.revokeObjectURL(url);
  }

  // Meaningful Reflection modal
  function openMeaningfulReflection(){ document.getElementById('meaningfulModal').style.display='flex'; }
  function closeMeaningfulReflection(){ document.getElementById('meaningfulModal').style.display='none'; }

  // Enable/disable Save on STEP 1
  function checkEmotionInputs() {
    const reactive = document.getElementById('reactiveStory')?.value.trim() || '';
    const off = document.getElementById('somethingOff')?.value.trim() || '';
    const core = document.getElementById('coreFeeling')?.value.trim() || '';
    const saveBtn = document.getElementById('saveEmotionStep');
    if (saveBtn) {
      const hasContent = !!(reactive || off || core);
      saveBtn.disabled = !hasContent;
      saveBtn.textContent = hasContent ? 'Where You Feel It →' : 'Complete Emotional Check-in to Continue';
    }
  }

  // Make functions globally available
  window.nextStep = nextStep;
  window.prevStep = prevStep;
  window.confirmStartOver = confirmStartOver;
  window.downloadSummary = downloadSummary;
  window.openMeaningfulReflection = openMeaningfulReflection;
  window.closeMeaningfulReflection = closeMeaningfulReflection;
  window.returnToDashboard = returnToDashboard;

  // Init
  async function init(){ 
    // Test database connection
    await testDatabaseConnection();
    
    // Load saved responses
    try {
      const saved = localStorage.getItem('emotionalAnchorResponses');
      if (saved) {
        const savedResponses = JSON.parse(saved);
        Object.assign(responses, savedResponses);
        // Populate form fields
        Object.keys(savedResponses).forEach(key => {
          const el = document.getElementById(key);
          if (el && savedResponses[key]) el.value = savedResponses[key];
        });
      }
    } catch (e) {
      console.warn('Could not load from localStorage:', e);
    }
    
    showStep(0);
    
    setTimeout(() => {
      ['reactiveStory','somethingOff','coreFeeling'].forEach(id=>{
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', checkEmotionInputs);
      });
      
      // Setup anchor statement auto-save
      setupAnchorStatementAutoSave();
      
      // Check button state on load to handle restored content
      checkEmotionInputs();
    }, 100);
  }
  
  if (document.readyState === 'loading'){ 
    document.addEventListener('DOMContentLoaded', init); 
  } else { 
    init(); 
  }
</script>
</body>
</html>
