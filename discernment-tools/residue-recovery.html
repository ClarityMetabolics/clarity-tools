<!DOCTYPE html>
<!--
Residue Recovery v1.0.1
Release Date: August 5, 2025
Author: Clarity Metabolics
Part of: Discernment Toolkit Series
Features: 7-step residue processing, checkbox selection, breathing pause, Trinity integration, dark/light modes
-->
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Residue Recovery | Discernment Toolkit by Clarity Metabolics</title>
<link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:wght@400;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
<style>
:root {
--main: #7A94A8;
--accent: #E7EEF1;
--contrast: #4A5A6A;
--bg-primary: #fff;
--bg-secondary: #E7EEF1;
--text-primary: #4A5A6A;
--text-secondary: #888;
}

[data-theme="dark"] {
--main: #9BB4C8;
--accent: #2A3441;
--contrast: #E8EDF2;
--bg-primary: #1A2028;
--bg-secondary: #2A3441;
--text-primary: #E8EDF2;
--text-secondary: #B0B8C0;
}

* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
font-family: 'Open Sans', sans-serif;
background: var(--bg-secondary);
min-height: 100vh;
color: var(--text-primary);
line-height: 1.6;
transition: all 0.3s ease;
}

.container {
max-width: 650px;
margin: 0 auto;
padding: 20px;
min-height: 100vh;
display: flex;
flex-direction: column;
justify-content: center;
position: relative;
}

.theme-toggle {
position: fixed;
top: 20px;
right: 20px;
background: var(--main);
color: var(--bg-primary);
border: none;
border-radius: 50%;
width: 50px;
height: 50px;
font-size: 1.2rem;
cursor: pointer;
transition: all 0.3s ease;
z-index: 1000;
box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.theme-toggle:hover {
transform: scale(1.1);
background: var(--contrast);
}

.card {
background: var(--bg-primary);
border-radius: 20px;
padding: 40px 35px;
box-shadow: 0 10px 30px rgba(74, 90, 106, 0.1);
text-align: center;
transition: all 0.3s ease;
border: 1px solid var(--accent);
}

.progress-bar {
width: 100%;
height: 6px;
background: var(--accent);
border-radius: 3px;
margin-bottom: 25px;
overflow: hidden;
}

.progress-fill {
height: 100%;
background: linear-gradient(90deg, var(--main), var(--contrast));
border-radius: 3px;
transition: width 0.3s ease;
}

.progress-indicator {
text-align: center;
font-size: 0.9rem;
color: var(--text-secondary);
margin-bottom: 10px;
font-weight: 500;
}

.progress-dots {
display: flex;
justify-content: center;
gap: 8px;
margin-bottom: 20px;
}

.dot {
width: 8px;
height: 8px;
border-radius: 50%;
background: var(--accent);
transition: all 0.3s ease;
position: relative;
}

.dot.active {
background: var(--main);
transform: scale(1.2);
}

.dot.completed {
background: #4CAF50;
transform: scale(1.1);
}

.dot.completed::after {
content: '‚úì';
position: absolute;
top: -2px;
left: 1px;
font-size: 10px;
color: white;
font-weight: bold;
}

.progress-note {
text-align: center;
font-size: 0.8rem;
color: var(--text-secondary);
font-style: italic;
margin-bottom: 15px;
}

.icon-header {
font-size: 3rem;
margin-bottom: 20px;
opacity: 0.8;
}

h1 {
font-family: 'Libre Baskerville', serif;
font-size: 2.2rem;
color: var(--text-primary);
margin-bottom: 15px;
line-height: 1.3;
}

.subtitle {
font-style: italic;
font-size: 1.1rem;
color: var(--main);
margin-bottom: 25px;
font-family: 'Libre Baskerville', serif;
font-weight: 500;
}

h2 {
font-family: 'Libre Baskerville', serif;
font-size: 1.8rem;
color: var(--text-primary);
margin-bottom: 20px;
}

.body-text {
font-size: 1.05rem;
color: var(--text-primary);
margin-bottom: 30px;
text-align: left;
line-height: 1.75;
}

.prompt {
font-size: 1.1rem;
margin-bottom: 20px;
color: var(--text-primary);
text-align: left;
font-weight: 600;
}

.input-group {
margin: 25px 0;
position: relative;
}

textarea {
width: 100%;
padding: 15px;
border: 2px solid var(--main);
border-radius: 12px;
font-size: 1rem;
font-family: 'Open Sans', sans-serif;
background: var(--bg-primary);
color: var(--text-primary);
transition: all 0.3s ease;
min-height: 80px;
resize: vertical;
font-size: 16px;
}

textarea:focus {
outline: none;
border-color: var(--main);
box-shadow: 0 0 0 2px rgba(122, 148, 168, 0.15);
}

.auto-save-notification {
position: fixed;
top: 80px;
right: 20px;
background: var(--main);
color: var(--bg-primary);
padding: 8px 16px;
border-radius: 20px;
font-size: 0.8rem;
opacity: 0;
transform: translateY(-10px);
transition: all 0.3s ease;
z-index: 999;
box-shadow: 0 4px 12px rgba(122, 148, 168, 0.3);
}

.auto-save-notification.show {
opacity: 1;
transform: translateY(0);
}

.button-group {
display: flex;
gap: 10px;
justify-content: center;
flex-wrap: wrap;
}

.button.secondary {
background: transparent;
color: var(--main);
border: 2px solid var(--main);
}

.button.secondary:hover:not(:disabled) {
background: var(--main);
color: var(--bg-primary);
}

.char-count {
text-align: right;
font-size: 0.8rem;
color: var(--text-secondary);
margin-top: 5px;
}

.encouragement {
background: rgba(122, 148, 168, 0.1);
color: var(--main);
padding: 8px 12px;
border-radius: 8px;
font-size: 0.9rem;
margin-top: 8px;
opacity: 0;
transform: translateY(-5px);
transition: all 0.3s ease;
font-style: italic;
}

.encouragement.show {
opacity: 1;
transform: translateY(0);
}

.typing-prompt {
color: var(--main);
font-size: 0.9rem;
font-style: italic;
margin-top: 8px;
opacity: 0;
transition: opacity 0.3s ease;
}

.typing-prompt.show {
opacity: 1;
}

.button {
background: var(--main);
color: var(--bg-primary);
border: none;
padding: 15px 30px;
border-radius: 25px;
font-size: 1rem;
font-weight: 600;
cursor: pointer;
transition: all 0.3s ease;
margin: 10px;
min-width: 140px;
}

.button:hover:not(:disabled) {
background: var(--contrast);
transform: translateY(-2px);
box-shadow: 0 5px 15px rgba(122, 148, 168, 0.3);
}

.button:disabled {
background: var(--text-secondary);
cursor: not-allowed;
transform: none;
box-shadow: none;
}

.checkbox-group {
text-align: left;
margin: 20px 0;
}

.checkbox-item {
display: flex;
align-items: flex-start;
margin: 10px 0;
padding: 12px;
border-radius: 8px;
transition: background 0.3s ease;
cursor: pointer;
}

.checkbox-item:hover {
background: var(--accent);
}

.checkbox-item input[type="checkbox"] {
width: 18px;
height: 18px;
margin-right: 12px;
margin-top: 2px;
accent-color: var(--main);
flex-shrink: 0;
}

.checkbox-item label {
font-size: 1rem;
cursor: pointer;
flex: 1;
}

.custom-input {
margin-top: 10px;
margin-left: 30px;
}

.custom-input input {
width: 100%;
padding: 10px 12px;
font-size: 0.9rem;
border: 2px solid var(--main);
border-radius: 8px;
background: var(--bg-primary);
color: var(--text-primary);
}

.interlude-box {
background: linear-gradient(135deg, var(--accent) 0%, var(--bg-secondary) 100%);
border-left: 4px solid var(--main);
padding: 25px;
margin: 20px 0;
border-radius: 12px;
text-align: left;
}

.summary-box {
background: linear-gradient(135deg, rgba(122, 148, 168, 0.1) 0%, var(--accent) 100%);
border-left: 4px solid var(--main);
padding: 25px;
margin: 20px 0;
border-radius: 12px;
text-align: left;
}

.action-buttons {
display: flex;
flex-wrap: wrap;
justify-content: center;
gap: 15px;
margin-top: 30px;
}

.action-buttons button {
background: var(--main);
color: var(--bg-primary);
border: none;
padding: 12px 20px;
border-radius: 20px;
font-size: 0.9rem;
font-weight: 600;
cursor: pointer;
transition: all 0.3s ease;
min-width: 140px;
}

.action-buttons button:hover:not(:disabled) {
background: var(--contrast);
transform: translateY(-2px);
}

.action-buttons button:disabled {
background: var(--text-secondary);
cursor: not-allowed;
transform: none;
box-shadow: none;
}

.question {
opacity: 1;
transition: opacity 0.3s ease-in-out;
}

.fade-out { 
opacity: 0; 
}

.fade-in {
opacity: 0;
animation: fadeIn 0.4s ease-in-out forwards;
}

@keyframes fadeIn {
to { opacity: 1; }
}

.hidden {
display: none;
}

.modal {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background-color: rgba(20, 20, 20, 0.6);
display: flex;
align-items: center;
justify-content: center;
z-index: 1000;
overflow-y: auto;
}

.modal.hidden {
display: none;
}

.modal-content {
background-color: var(--bg-primary);
padding: 2rem;
border-radius: 15px;
max-width: 500px;
width: 90%;
max-height: 90vh;
overflow-y: auto;
color: var(--text-primary);
box-shadow: 0 8px 20px rgba(0,0,0,0.2);
position: relative;
text-align: center;
animation: fadeInModal 0.3s ease-out forwards;
border: 2px solid var(--accent);
margin: 20px;
}

.modal-content .body-text {
text-align: left;
line-height: 1.75;
}

.modal-content button {
background: var(--main);
color: var(--bg-primary);
border: none;
padding: 12px 24px;
border-radius: 20px;
font-size: 1rem;
font-weight: 600;
cursor: pointer;
transition: all 0.3s ease;
margin-top: 20px;
}

.modal-content button:hover {
background: var(--contrast);
transform: translateY(-2px);
}

.close-btn {
position: absolute;
top: 0.7rem;
right: 1rem;
font-size: 1.5rem;
cursor: pointer;
color: var(--text-primary);
}

@keyframes fadeInModal {
from {
transform: scale(0.9);
opacity: 0;
}
to {
transform: scale(1);
opacity: 1;
}
}

@media (max-width: 768px) {
.container {
padding: 15px;
margin: 1rem;
}

.card {
padding: 25px 20px;
}

.theme-toggle {
top: 15px;
right: 15px;
width: 45px;
height: 45px;
font-size: 1.1rem;
}

h1 {
font-size: 1.8rem;
}

.icon-header {
font-size: 1.6rem;
margin-bottom: 0.4em;
}

textarea {
padding: 0.8rem;
resize: none;
}

.action-buttons {
flex-direction: column;
align-items: center;
}

.action-buttons button {
width: 100%;
max-width: 300px;
}
}
</style>
</head>
<body>
<button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle dark mode">üåô</button>
<div class="auto-save-notification" id="autoSaveNotification">Progress saved ‚úì</div>

<div class="container">
<!-- Intro Screen -->
<div id="intro-screen" class="card">
<div class="progress-indicator">Step 1 of 7</div>
<div class="progress-bar">
<div class="progress-fill" style="width: 0%"></div>
</div>
<div class="progress-dots">
<div class="dot active"></div>
<div class="dot"></div>
<div class="dot"></div>
<div class="dot"></div>
<div class="dot"></div>
<div class="dot"></div>
<div class="dot"></div>
</div>
<div class="progress-note">Your progress is automatically saved as you type</div>

<div class="icon-header">üßº</div>
<h1>Residue Recovery</h1>
<p class="subtitle">Some lies don't fully leave when we let go of them. Let's finish what Truth started.</p>

<div class="body-text">
Even after a breakthrough, something can still cling to us ‚Äî a leftover sting, label, or fear. That's not a flaw. That's residue. And you're not stuck with it. Let's walk through 7 steps to help you recognize and release what's still lingering.
</div>

<p style="font-style: italic; color: var(--main); font-weight: 500;">What sticky residue from past wounds are you ready to finally release?</p>

<button class="button" onclick="nextStep('step1')">Start Recovery</button>
</div>

<!-- Step 1: What's still clinging? -->
<div id="step1" class="card hidden">
<div class="progress-indicator">Step 2 of 7</div>
<div class="progress-bar">
<div class="progress-fill" style="width: 14%"></div>
</div>
<div class="progress-dots">
<div class="dot completed"></div>
<div class="dot active"></div>
<div class="dot"></div>
<div class="dot"></div>
<div class="dot"></div>
<div class="dot"></div>
<div class="dot"></div>
</div>

<h2>üß∑ What's still clinging?</h2>
<p class="prompt">What's the residue that keeps showing up?</p>

<div class="checkbox-group">
<div class="checkbox-item">
<input type="checkbox" id="shame" value="shame">
<label for="shame">Shame</label>
</div>
<div class="checkbox-item">
<input type="checkbox" id="fear" value="fear">
<label for="fear">Fear</label>
</div>
<div class="checkbox-item">
<input type="checkbox" id="confusion" value="confusion">
<label for="confusion">Confusion</label>
</div>
<div class="checkbox-item">
<input type="checkbox" id="bitterness" value="bitterness">
<label for="bitterness">Bitterness</label>
</div>
<div class="checkbox-item">
<input type="checkbox" id="feeling-small" value="feeling-small">
<label for="feeling-small">Feeling small</label>
</div>
<div class="checkbox-item">
<input type="checkbox" id="prove-myself" value="prove-myself">
<label for="prove-myself">Wanting to prove myself</label>
</div>
<div class="checkbox-item">
<input type="checkbox" id="unseen" value="unseen">
<label for="unseen">Feeling unseen</label>
</div>
<div class="checkbox-item">
<input type="checkbox" id="resentment" value="resentment">
<label for="resentment">Resentment</label>
</div>
<div class="checkbox-item">
<input type="checkbox" id="not-enough" value="not-enough">
<label for="not-enough">"Not enough"</label>
</div>
<div class="checkbox-item">
<input type="checkbox" id="something-else" value="something-else">
<label for="something-else">Something else</label>
<div class="custom-input hidden" id="custom-residue-input">
<input type="text" placeholder="Describe what's clinging..." aria-label="Describe your custom residue">
</div>
</div>
</div>

<button class="button" onclick="nextStep('step2')" id="next1" disabled>Next</button>
</div>

<!-- Step 2: When did it begin? -->
<div id="step2" class="card hidden">
<div class="progress-indicator">Step 3 of 7</div>
<div class="progress-bar">
<div class="progress-fill" style="width: 29%"></div>
</div>
<div class="progress-dots">
<div class="dot completed"></div>
<div class="dot completed"></div>
<div class="dot active"></div>
<div class="dot"></div>
<div class="dot"></div>
<div class="dot"></div>
<div class="dot"></div>
</div>

<h2>üßª When did it begin?</h2>
<p class="prompt">Can you trace when this residue first appeared? Was there a moment, phrase, conflict, or experience that seeded it?</p>

<div class="input-group">
<textarea id="cause-input" placeholder="Go back. What seeded this? When did it start to cling?" 
aria-label="Describe when this residue first began"
oninput="updateCharCount(this, 'count2'); showEncouragement(this, 'enc2')"
onkeydown="handleKeyPress(event, 2)"></textarea>
<div class="char-count" id="count2">0 characters</div>
<div class="encouragement" id="enc2">Sometimes the root is loud. Sometimes it hides under years of dust.</div>
<div class="typing-prompt" id="prompt2">Take your time. Sometimes the hardest truths are the most healing to speak.</div>
</div>

<div class="button-group">
<button class="button secondary" onclick="previousStep('step1')" id="back2">‚Üê Back</button>
<button class="button" onclick="nextStep('step3')" id="next2" disabled>Next</button>
</div>
</div>

<!-- Step 3: Where did it attach? -->
<div id="step3" class="card hidden">
<div class="progress-indicator">Step 4 of 7</div>
<div class="progress-bar">
<div class="progress-fill" style="width: 43%"></div>
</div>
<div class="progress-dots">
<div class="dot completed"></div>
<div class="dot completed"></div>
<div class="dot completed"></div>
<div class="dot active"></div>
<div class="dot"></div>
<div class="dot"></div>
<div class="dot"></div>
</div>

<h2>üéØ Where did it attach?</h2>
<p class="prompt">What part of you did this residue cling to? Was it a belief? A memory? A fear? A label? And ‚Äî where in your body do you feel it most?</p>

<div class="input-group">
<textarea id="attachment-input" placeholder="Where do you feel it most? In thought? In a memory? In your body?" 
aria-label="Describe where this residue attached"
oninput="updateCharCount(this, 'count3'); showEncouragement(this, 'enc3')"
onkeydown="handleKeyPress(event, 3)"></textarea>
<div class="char-count" id="count3">0 characters</div>
<div class="encouragement" id="enc3">Residue binds itself to what feels vulnerable. Sometimes that's emotional‚Ä¶ sometimes physical.</div>
<div class="typing-prompt" id="prompt3">Notice what comes up. Your body holds wisdom about where pain landed.</div>
</div>

<div class="button-group">
<button class="button secondary" onclick="previousStep('step2')" id="back3">‚Üê Back</button>
<button class="button" onclick="nextStep('step4')" id="next3" disabled>Next</button>
</div>
</div>

<!-- Step 4: What has it cost you? -->
<div id="step4" class="card hidden">
<div class="progress-indicator">Step 5 of 7</div>
<div class="progress-bar">
<div class="progress-fill" style="width: 57%"></div>
</div>
<div class="progress-dots">
<div class="dot completed"></div>
<div class="dot completed"></div>
<div class="dot completed"></div>
<div class="dot completed"></div>
<div class="dot active"></div>
<div class="dot"></div>
<div class="dot"></div>
</div>

<h2>üí∏ What has it cost you?</h2>
<p class="prompt">What has this residue kept you from doing, being, or believing? Has it dimmed your courage? Stolen your stillness? Distorted your sense of who you are?</p>

<div class="input-group">
<textarea id="cost-input" placeholder="What have you lost or silenced because of this residue?" 
aria-label="Describe what this residue has cost you"
oninput="updateCharCount(this, 'count4'); showEncouragement(this, 'enc4')"
onkeydown="handleKeyPress(event, 4)"></textarea>
<div class="char-count" id="count4">0 characters</div>
<div class="encouragement" id="enc4">Naming the cost is not shameful ‚Äî it's sacred clarity.</div>
<div class="typing-prompt" id="prompt4">This matters. What you've lost matters. Let yourself feel it.</div>
</div>

<div class="button-group">
<button class="button secondary" onclick="previousStep('step3')" id="back4">‚Üê Back</button>
<button class="button" onclick="nextStep('step5')" id="next4" disabled>Next</button>
</div>
</div>

<!-- Step 5: What's truer than the residue? -->
<div id="step5" class="card hidden">
<div class="progress-indicator">Step 6 of 7</div>
<div class="progress-bar">
<div class="progress-fill" style="width: 71%"></div>
</div>
<div class="progress-dots">
<div class="dot completed"></div>
<div class="dot completed"></div>
<div class="dot completed"></div>
<div class="dot completed"></div>
<div class="dot completed"></div>
<div class="dot active"></div>
<div class="dot"></div>
</div>

<h2>‚ú® What's truer than the residue?</h2>
<p class="prompt">What truth do you sense now that stands in contrast to the residue? Even if it feels faint, whisper it here.</p>

<div class="input-group">
<textarea id="truth-input" placeholder="What's clearer now? What truth is returning?" 
aria-label="Describe the truth that counters this residue"
oninput="updateCharCount(this, 'count5'); showEncouragement(this, 'enc5')"
onkeydown="handleKeyPress(event, 5)"></textarea>
<div class="char-count" id="count5">0 characters</div>
<div class="encouragement" id="enc5">Truth doesn't need volume. It just needs a witness.</div>
<div class="typing-prompt" id="prompt5">Even a whisper of truth is enough. What do you sense stirring?</div>
</div>

<div class="button-group">
<button class="button secondary" onclick="previousStep('step4')" id="back5">‚Üê Back</button>
<button class="button" onclick="nextStep('step6')" id="next5" disabled>Next</button>
</div>
</div>

<!-- Step 6: How will you release it? -->
<div id="step6" class="card hidden">
<div class="progress-indicator">Step 7 of 7</div>
<div class="progress-bar">
<div class="progress-fill" style="width: 85%"></div>
</div>
<div class="progress-dots">
<div class="dot completed"></div>
<div class="dot completed"></div>
<div class="dot completed"></div>
<div class="dot completed"></div>
<div class="dot completed"></div>
<div class="dot completed"></div>
<div class="dot active"></div>
</div>

<h2>üïäÔ∏è How will you release it?</h2>
<p class="prompt">What is your next act of release? A prayer? A boundary? A breath? A declaration of truth? Write what you feel led to do ‚Äî or simply say yes.</p>

<div class="input-group">
<textarea id="release-input" placeholder="Write your act of release ‚Äî or a simple yes." 
aria-label="Describe how you will release this residue"
oninput="updateCharCount(this, 'count6'); showEncouragement(this, 'enc6')"
onkeydown="handleKeyPress(event, 6)"></textarea>
<div class="char-count" id="count6">0 characters</div>
<div class="encouragement" id="enc6">You're not doing this alone. Invite the Trinity to rinse what remains.</div>
<div class="typing-prompt" id="prompt6">What feels right? Trust what emerges.</div>
</div>

<div class="button-group">
<button class="button secondary" onclick="previousStep('step5')" id="back6">‚Üê Back</button>
<button class="button" onclick="nextStep('breathing-pause')" id="next6" disabled>Complete</button>
</div>
</div>

<!-- Breathing Pause -->
<div id="breathing-pause" class="card hidden">
<div class="progress-bar">
<div class="progress-fill" style="width: 95%"></div>
</div>

<div class="icon-header">üå¨Ô∏è</div>
<h2>Take a Breath</h2>

<div class="body-text">
You've done beautiful, difficult work. Before we continue to your reflection, take a moment to breathe. Let what you've discovered settle.
</div>

<div class="interlude-box">
<p style="text-align: center; font-style: italic;">
"Be still and know that I am God." <br>
<span style="font-size: 0.9rem; opacity: 0.8;">- Psalm 46:10</span>
</p>
</div>

<div class="button-group">
<button class="button secondary" onclick="previousStep('step6')">‚Üê Back</button>
<button class="button" onclick="nextStep('final')">Continue to Reflection</button>
</div>
</div>

<!-- Final Summary -->
<div id="final" class="card hidden">
<div class="progress-bar">
<div class="progress-fill" style="width: 100%"></div>
</div>

<div class="icon-header">üåø</div>
<h2>You've Done Holy Work</h2>

<div class="body-text">Below is a reflection of what you've just uncovered. Save or print if you wish ‚Äî but more importantly, notice what feels lighter. What feels clearer.</div>

<div class="summary-box" id="personalized-summary">
<h3 style="color: var(--main); margin-bottom: 15px;">Your Residue Recovery Reflection</h3>
<div id="summary-content">
<!-- Summary will be populated by JavaScript -->
</div>
</div>

<div class="action-buttons">
<button onclick="downloadResults()" aria-label="Download your reflection as a text file">Download .txt</button>
<button onclick="printResults()" aria-label="Print or save your reflection">Save/Print</button>
<button onclick="showTrinityModal()" aria-label="Let the Trinity speak into this">‚ú® Trinity Speaks</button>
<button onclick="startOver()" id="start-over-btn">Start Over</button>
</div>
</div>

<!-- Trinity Modal -->
<div id="trinityModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
<div class="modal-content">
<span class="close-btn" onclick="toggleTrinityModal()" aria-label="Close modal">&times;</span>
<h2 id="modalTitle">‚ú® Let the Trinity Speak Into This</h2>
<div class="body-text">
<p><strong>Father:</strong> "My child, I see every wound that has touched you. What feels like residue to you is known to Me. I am making all things new ‚Äî including the places that still ache. Rest in My love that never changes, never leaves, never lies."</p>

<p><strong>Jesus:</strong> "I know what it's like to carry what doesn't belong to you. I took on shame that wasn't Mine so you could be free of shame that isn't yours. The cross finished what fear started. Let My finished work finish what's still clinging to you."</p>

<p><strong>Holy Spirit:</strong> "I am the Comforter, the One who comes alongside. What feels stuck in you, I can unstick. What feels tangled, I can untangle. Breathe Me in. Let Me breathe through what's been holding its breath."</p>

<p style="text-align: center; font-style: italic; color: var(--main); margin-top: 20px;">
"And the peace of God, which transcends all understanding, will guard your hearts and your minds in Christ Jesus."<br>
<span style="font-size: 0.9rem;">- Philippians 4:7</span>
</p>
</div>
<button onclick="toggleTrinityModal()">Close</button>
</div>
</div>

</div>

<script>
let currentStep = 'intro-screen';
let userResponses = {};

// Auto-save functionality
function autoSave() {
    const notification = document.getElementById('autoSaveNotification');
    notification.classList.add('show');
    setTimeout(() => {
        notification.classList.remove('show');
    }, 2000);
}

// Theme toggle
function toggleTheme() {
    const body = document.body;
    const themeToggle = document.querySelector('.theme-toggle');
    
    if (body.getAttribute('data-theme') === 'dark') {
        body.setAttribute('data-theme', 'light');
        themeToggle.textContent = 'üåô';
    } else {
        body.setAttribute('data-theme', 'dark');
        themeToggle.textContent = '‚òÄÔ∏è';
    }
}

// Character count and encouragement
function updateCharCount(textarea, countId) {
    const count = textarea.value.length;
    document.getElementById(countId).textContent = `${count} characters`;
    
    // Enable/disable next button based on content (only need 1 character)
    const stepNum = countId.replace('count', '');
    const nextBtn = document.getElementById('next' + stepNum);
    if (nextBtn) {
        nextBtn.disabled = count < 1;
    }
    
    // Auto-save simulation
    if (count > 0) {
        clearTimeout(window.autoSaveTimeout);
        window.autoSaveTimeout = setTimeout(autoSave, 1000);
    }
}

function showEncouragement(textarea, encId) {
    const encouragement = document.getElementById(encId);
    const prompt = document.getElementById(encId.replace('enc', 'prompt'));
    
    if (textarea.value.length > 20) {
        encouragement.classList.add('show');
        prompt.classList.add('show');
    }
}

// Handle Enter key to move to next step
function handleKeyPress(event, stepNum) {
    if (event.key === 'Enter' && event.ctrlKey) {
        const nextBtn = document.getElementById('next' + stepNum);
        if (nextBtn && !nextBtn.disabled) {
            nextBtn.click();
        }
    }
}

// Navigation functions
function nextStep(nextStepId) {
    // Save current responses
    saveCurrentResponse();
    
    // Hide current step
    document.getElementById(currentStep).classList.add('hidden');
    
    // Show next step
    document.getElementById(nextStepId).classList.remove('hidden');
    currentStep = nextStepId;
    
    // Update progress dots
    updateProgressDots();
    
    // Focus on first input if it exists
    const nextInput = document.querySelector(`#${nextStepId} textarea, #${nextStepId} input[type="text"]`);
    if (nextInput) {
        setTimeout(() => nextInput.focus(), 100);
    }
}

function previousStep(prevStepId) {
    // Save current responses
    saveCurrentResponse();
    
    // Hide current step
    document.getElementById(currentStep).classList.add('hidden');
    
    // Show previous step
    document.getElementById(prevStepId).classList.remove('hidden');
    currentStep = prevStepId;
    
    // Update progress dots
    updateProgressDots();
}

function updateProgressDots() {
    const dots = document.querySelectorAll('.dot');
    const steps = ['intro-screen', 'step1', 'step2', 'step3', 'step4', 'step5', 'step6', 'breathing-pause', 'final'];
    const currentIndex = steps.indexOf(currentStep);
    
    dots.forEach((dot, index) => {
        dot.classList.remove('active', 'completed');
        if (index < currentIndex) {
            dot.classList.add('completed');
        } else if (index === currentIndex) {
            dot.classList.add('active');
        }
    });
}

function saveCurrentResponse() {
    // Save checkbox selections
    const checkboxes = document.querySelectorAll(`#${currentStep} input[type="checkbox"]:checked`);
    if (checkboxes.length > 0) {
        userResponses.selectedResidues = Array.from(checkboxes).map(cb => cb.value);
        
        // Save custom input if "something-else" is selected
        const customInput = document.querySelector('#custom-residue-input input');
        if (customInput && customInput.value) {
            userResponses.customResidue = customInput.value;
        }
    }
    
    // Save textarea responses
    const textarea = document.querySelector(`#${currentStep} textarea`);
    if (textarea && textarea.value) {
        const stepMapping = {
            'step2': 'cause',
            'step3': 'attachment', 
            'step4': 'cost',
            'step5': 'truth',
            'step6': 'release'
        };
        
        const responseKey = stepMapping[currentStep];
        if (responseKey) {
            userResponses[responseKey] = textarea.value;
        }
    }
}

// Checkbox handling
document.addEventListener('DOMContentLoaded', function() {
    // Handle checkbox selections
    const checkboxes = document.querySelectorAll('#step1 input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const nextBtn = document.getElementById('next1');
            const anyChecked = document.querySelectorAll('#step1 input[type="checkbox"]:checked').length > 0;
            nextBtn.disabled = !anyChecked;
            
            // Show/hide custom input
            if (this.id === 'something-else') {
                const customInput = document.getElementById('custom-residue-input');
                if (this.checked) {
                    customInput.classList.remove('hidden');
                    customInput.querySelector('input').focus();
                } else {
                    customInput.classList.add('hidden');
                }
            }
        });
    });
    
    // Handle click on checkbox items (not just the checkbox itself)
    const checkboxItems = document.querySelectorAll('.checkbox-item');
    checkboxItems.forEach(item => {
        item.addEventListener('click', function(e) {
            if (e.target.type !== 'checkbox' && e.target.tagName !== 'INPUT') {
                const checkbox = this.querySelector('input[type="checkbox"]');
                checkbox.checked = !checkbox.checked;
                checkbox.dispatchEvent(new Event('change'));
            }
        });
    });
});

// Final summary generation
function generateSummary() {
    let summary = '<h4 style="color: var(--main);">What you discovered:</h4><br>';
    
    if (userResponses.selectedResidues) {
        summary += `<strong>Residue identified:</strong> ${userResponses.selectedResidues.join(', ')}`;
        if (userResponses.customResidue) {
            summary += `, ${userResponses.customResidue}`;
        }
        summary += '<br><br>';
    }
    
    if (userResponses.cause) {
        summary += `<strong>When it began:</strong> ${userResponses.cause}<br><br>`;
    }
    
    if (userResponses.attachment) {
        summary += `<strong>Where it attached:</strong> ${userResponses.attachment}<br><br>`;
    }
    
    if (userResponses.cost) {
        summary += `<strong>What it cost you:</strong> ${userResponses.cost}<br><br>`;
    }
    
    if (userResponses.truth) {
        summary += `<strong>What's truer:</strong> ${userResponses.truth}<br><br>`;
    }
    
    if (userResponses.release) {
        summary += `<strong>Your act of release:</strong> ${userResponses.release}<br><br>`;
    }
    
    summary += '<p style="font-style: italic; color: var(--main); margin-top: 20px;">Remember: You are seen, known, and deeply loved. What was once clinging has loosened its grip.</p>';
    
    document.getElementById('summary-content').innerHTML = summary;
}

// Show final step
function showFinal() {
    saveCurrentResponse();
    generateSummary();
    nextStep('final');
}

// Update the step navigation to use showFinal for the last step
document.addEventListener('DOMContentLoaded', function() {
    const completeBtn = document.getElementById('next6');
    if (completeBtn) {
        completeBtn.onclick = function() { nextStep('breathing-pause'); };
    }
});

// Trinity modal functions
function showTrinityModal() {
    document.getElementById('trinityModal').classList.remove('hidden');
}

function toggleTrinityModal() {
    document.getElementById('trinityModal').classList.toggle('hidden');
}

// Download and print functions
function downloadResults() {
    saveCurrentResponse();
    const timestamp = new Date().toLocaleDateString();
    let content = `Residue Recovery Reflection - ${timestamp}\n`;
    content += `Generated by Clarity Metabolics Discernment Toolkit\n\n`;
    content += `========================================\n\n`;
    
    if (userResponses.selectedResidues) {
        content += `RESIDUE IDENTIFIED:\n${userResponses.selectedResidues.join(', ')}`;
        if (userResponses.customResidue) {
            content += `, ${userResponses.customResidue}`;
        }
        content += '\n\n';
    }
    
    if (userResponses.cause) {
        content += `WHEN IT BEGAN:\n${userResponses.cause}\n\n`;
    }
    
    if (userResponses.attachment) {
        content += `WHERE IT ATTACHED:\n${userResponses.attachment}\n\n`;
    }
    
    if (userResponses.cost) {
        content += `WHAT IT COST YOU:\n${userResponses.cost}\n\n`;
    }
    
    if (userResponses.truth) {
        content += `WHAT'S TRUER:\n${userResponses.truth}\n\n`;
    }
    
    if (userResponses.release) {
        content += `YOUR ACT OF RELEASE:\n${userResponses.release}\n\n`;
    }
    
    content += `========================================\n\n`;
    content += `TRINITY REFLECTION:\n\n`;
    content += `Father: "My child, I see every wound that has touched you. What feels like residue to you is known to Me. I am making all things new ‚Äî including the places that still ache. Rest in My love that never changes, never leaves, never lies."\n\n`;
    content += `Jesus: "I know what it's like to carry what doesn't belong to you. I took on shame that wasn't Mine so you could be free of shame that isn't yours. The cross finished what fear started. Let My finished work finish what's still clinging to you."\n\n`;
    content += `Holy Spirit: "I am the Comforter, the One who comes alongside. What feels stuck in you, I can unstick. What feels tangled, I can untangle. Breathe Me in. Let Me breathe through what's been holding its breath."\n\n`;
    content += `"And the peace of God, which transcends all understanding, will guard your hearts and your minds in Christ Jesus." - Philippians 4:7\n\n`;
    content += `Remember: You are seen, known, and deeply loved. What was once clinging has loosened its grip.\n\n`;
    content += `For more tools and support: claritymetabolics.github.io/clarity-tools`;
    
    const blob = new Blob([content], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `residue-recovery-reflection-${timestamp.replace(/\//g, '-')}.txt`;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
}

function printResults() {
    window.print();
}

function startOver() {
    const startOverBtn = document.getElementById('start-over-btn');
    
    // Change button to red confirmation state
    if (!startOverBtn.classList.contains('confirm-state')) {
        startOverBtn.style.background = '#e74c3c';
        startOverBtn.textContent = 'Click Again to Confirm';
        startOverBtn.classList.add('confirm-state');
        
        // Reset after 3 seconds if not clicked
        setTimeout(() => {
            if (startOverBtn.classList.contains('confirm-state')) {
                startOverBtn.style.background = '';
                startOverBtn.textContent = 'Start Over';
                startOverBtn.classList.remove('confirm-state');
            }
        }, 3000);
        
        return;
    }
    
    // Actually start over
    userResponses = {};
    
    // Reset all form inputs
    document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
    document.querySelectorAll('textarea').forEach(ta => ta.value = '');
    document.querySelectorAll('input[type="text"]').forEach(input => input.value = '');
    
    // Reset character counts
    document.querySelectorAll('.char-count').forEach(count => count.textContent = '0 characters');
    
    // Hide encouragements
    document.querySelectorAll('.encouragement').forEach(enc => enc.classList.remove('show'));
    document.querySelectorAll('.typing-prompt').forEach(prompt => prompt.classList.remove('show'));
    
    // Hide custom input
    document.getElementById('custom-residue-input').classList.add('hidden');
    
    // Disable all next buttons
    document.querySelectorAll('[id^="next"]').forEach(btn => btn.disabled = true);
    
    // Reset button state
    startOverBtn.style.background = '';
    startOverBtn.textContent = 'Start Over';
    startOverBtn.classList.remove('confirm-state');
    
    // Go back to intro
    document.getElementById(currentStep).classList.add('hidden');
    document.getElementById('intro-screen').classList.remove('hidden');
    currentStep = 'intro-screen';
    
    updateProgressDots();
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    updateProgressDots();
    
    // Handle checkbox selections for step 1
    const checkboxes = document.querySelectorAll('#step1 input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const nextBtn = document.getElementById('next1');
            const anyChecked = document.querySelectorAll('#step1 input[type="checkbox"]:checked').length > 0;
            nextBtn.disabled = !anyChecked;
            
            // Show/hide custom input
            if (this.id === 'something-else') {
                const customInput = document.getElementById('custom-residue-input');
                if (this.checked) {
                    customInput.classList.remove('hidden');
                    customInput.querySelector('input').focus();
                } else {
                    customInput.classList.add('hidden');
                }
            }
        });
    });
    
    // Handle click on checkbox items (including the label text)
    const checkboxItems = document.querySelectorAll('.checkbox-item');
    checkboxItems.forEach(item => {
        item.addEventListener('click', function(e) {
            // Don't trigger if clicking on input field
            if (e.target.tagName === 'INPUT' && e.target.type === 'text') {
                return;
            }
            
            // If not clicking directly on checkbox, toggle it
            if (e.target.type !== 'checkbox') {
                const checkbox = this.querySelector('input[type="checkbox"]');
                checkbox.checked = !checkbox.checked;
                checkbox.dispatchEvent(new Event('change'));
            }
        });
    });
    
    // Update breathing pause to go to final
    const breathingContinue = document.querySelector('#breathing-pause .button:not(.secondary)');
    if (breathingContinue) {
        breathingContinue.onclick = function() { 
            saveCurrentResponse();
            generateSummary();
            nextStep('final');
        };
    }
});

// Close modal when clicking outside
document.addEventListener('click', function(event) {
    const modal = document.getElementById('trinityModal');
    if (event.target === modal) {
        toggleTrinityModal();
    }
});

// Escape key to close modal
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        const modal = document.getElementById('trinityModal');
        if (!modal.classList.contains('hidden')) {
            toggleTrinityModal();
        }
    }
});
</script>
</body>
</html>
